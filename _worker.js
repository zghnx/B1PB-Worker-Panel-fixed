var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__require=(e=>"undefined"!=typeof require?require:"undefined"!=typeof Proxy?new Proxy(e,{get:(e,t)=>("undefined"!=typeof require?require:e)[t]}):e)((function(e){if("undefined"!=typeof require)return require.apply(this,arguments);throw new Error('Dynamic require of "'+e+'" is not supported')})),__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,n,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of __getOwnPropNames(t))__hasOwnProp.call(e,o)||o===n||__defProp(e,o,{get:()=>t[o],enumerable:!(r=__getOwnPropDesc(t,o))||r.enumerable});return e},__toESM=(e,t,n)=>(n=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?n:__defProp(n,"default",{value:e,enumerable:!0}),e)),require_crypto=__commonJS({"(disabled):crypto"(){}}),require_nacl_fast=__commonJS({"node_modules/tweetnacl/nacl-fast.js"(e,t){!function(e){"use strict";var t=function(e){var t,n=new Float64Array(16);if(e)for(t=0;t<e.length;t++)n[t]=e[t];return n},n=function(){throw new Error("no PRNG")},r=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var a=t(),s=t([1]),i=t([56129,1]),l=t([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),c=t([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),d=t([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),u=t([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),p=t([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function h(e,t,n,r){e[t]=n>>24&255,e[t+1]=n>>16&255,e[t+2]=n>>8&255,e[t+3]=255&n,e[t+4]=r>>24&255,e[t+5]=r>>16&255,e[t+6]=r>>8&255,e[t+7]=255&r}function f(e,t,n,r,o){var a,s=0;for(a=0;a<o;a++)s|=e[t+a]^n[r+a];return(1&s-1>>>8)-1}function y(e,t,n,r){return f(e,t,n,r,16)}function m(e,t,n,r){return f(e,t,n,r,32)}function b(e,t,n,r){!function(e,t,n,r){for(var o,a=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,s=255&n[0]|(255&n[1])<<8|(255&n[2])<<16|(255&n[3])<<24,i=255&n[4]|(255&n[5])<<8|(255&n[6])<<16|(255&n[7])<<24,l=255&n[8]|(255&n[9])<<8|(255&n[10])<<16|(255&n[11])<<24,c=255&n[12]|(255&n[13])<<8|(255&n[14])<<16|(255&n[15])<<24,d=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,u=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,p=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,h=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,f=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,y=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,m=255&n[16]|(255&n[17])<<8|(255&n[18])<<16|(255&n[19])<<24,b=255&n[20]|(255&n[21])<<8|(255&n[22])<<16|(255&n[23])<<24,g=255&n[24]|(255&n[25])<<8|(255&n[26])<<16|(255&n[27])<<24,v=255&n[28]|(255&n[29])<<8|(255&n[30])<<16|(255&n[31])<<24,w=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,S=a,x=s,k=i,_=l,C=c,P=d,E=u,A=p,T=h,I=f,D=y,R=m,N=b,$=g,W=v,M=w,O=0;O<20;O+=2)S^=(o=(N^=(o=(T^=(o=(C^=(o=S+N|0)<<7|o>>>25)+S|0)<<9|o>>>23)+C|0)<<13|o>>>19)+T|0)<<18|o>>>14,P^=(o=(x^=(o=($^=(o=(I^=(o=P+x|0)<<7|o>>>25)+P|0)<<9|o>>>23)+I|0)<<13|o>>>19)+$|0)<<18|o>>>14,D^=(o=(E^=(o=(k^=(o=(W^=(o=D+E|0)<<7|o>>>25)+D|0)<<9|o>>>23)+W|0)<<13|o>>>19)+k|0)<<18|o>>>14,M^=(o=(R^=(o=(A^=(o=(_^=(o=M+R|0)<<7|o>>>25)+M|0)<<9|o>>>23)+_|0)<<13|o>>>19)+A|0)<<18|o>>>14,S^=(o=(_^=(o=(k^=(o=(x^=(o=S+_|0)<<7|o>>>25)+S|0)<<9|o>>>23)+x|0)<<13|o>>>19)+k|0)<<18|o>>>14,P^=(o=(C^=(o=(A^=(o=(E^=(o=P+C|0)<<7|o>>>25)+P|0)<<9|o>>>23)+E|0)<<13|o>>>19)+A|0)<<18|o>>>14,D^=(o=(I^=(o=(T^=(o=(R^=(o=D+I|0)<<7|o>>>25)+D|0)<<9|o>>>23)+R|0)<<13|o>>>19)+T|0)<<18|o>>>14,M^=(o=(W^=(o=($^=(o=(N^=(o=M+W|0)<<7|o>>>25)+M|0)<<9|o>>>23)+N|0)<<13|o>>>19)+$|0)<<18|o>>>14;S=S+a|0,x=x+s|0,k=k+i|0,_=_+l|0,C=C+c|0,P=P+d|0,E=E+u|0,A=A+p|0,T=T+h|0,I=I+f|0,D=D+y|0,R=R+m|0,N=N+b|0,$=$+g|0,W=W+v|0,M=M+w|0,e[0]=S>>>0&255,e[1]=S>>>8&255,e[2]=S>>>16&255,e[3]=S>>>24&255,e[4]=x>>>0&255,e[5]=x>>>8&255,e[6]=x>>>16&255,e[7]=x>>>24&255,e[8]=k>>>0&255,e[9]=k>>>8&255,e[10]=k>>>16&255,e[11]=k>>>24&255,e[12]=_>>>0&255,e[13]=_>>>8&255,e[14]=_>>>16&255,e[15]=_>>>24&255,e[16]=C>>>0&255,e[17]=C>>>8&255,e[18]=C>>>16&255,e[19]=C>>>24&255,e[20]=P>>>0&255,e[21]=P>>>8&255,e[22]=P>>>16&255,e[23]=P>>>24&255,e[24]=E>>>0&255,e[25]=E>>>8&255,e[26]=E>>>16&255,e[27]=E>>>24&255,e[28]=A>>>0&255,e[29]=A>>>8&255,e[30]=A>>>16&255,e[31]=A>>>24&255,e[32]=T>>>0&255,e[33]=T>>>8&255,e[34]=T>>>16&255,e[35]=T>>>24&255,e[36]=I>>>0&255,e[37]=I>>>8&255,e[38]=I>>>16&255,e[39]=I>>>24&255,e[40]=D>>>0&255,e[41]=D>>>8&255,e[42]=D>>>16&255,e[43]=D>>>24&255,e[44]=R>>>0&255,e[45]=R>>>8&255,e[46]=R>>>16&255,e[47]=R>>>24&255,e[48]=N>>>0&255,e[49]=N>>>8&255,e[50]=N>>>16&255,e[51]=N>>>24&255,e[52]=$>>>0&255,e[53]=$>>>8&255,e[54]=$>>>16&255,e[55]=$>>>24&255,e[56]=W>>>0&255,e[57]=W>>>8&255,e[58]=W>>>16&255,e[59]=W>>>24&255,e[60]=M>>>0&255,e[61]=M>>>8&255,e[62]=M>>>16&255,e[63]=M>>>24&255}(e,t,n,r)}function g(e,t,n,r){!function(e,t,n,r){for(var o,a=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,s=255&n[0]|(255&n[1])<<8|(255&n[2])<<16|(255&n[3])<<24,i=255&n[4]|(255&n[5])<<8|(255&n[6])<<16|(255&n[7])<<24,l=255&n[8]|(255&n[9])<<8|(255&n[10])<<16|(255&n[11])<<24,c=255&n[12]|(255&n[13])<<8|(255&n[14])<<16|(255&n[15])<<24,d=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,u=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,p=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,h=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,f=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,y=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,m=255&n[16]|(255&n[17])<<8|(255&n[18])<<16|(255&n[19])<<24,b=255&n[20]|(255&n[21])<<8|(255&n[22])<<16|(255&n[23])<<24,g=255&n[24]|(255&n[25])<<8|(255&n[26])<<16|(255&n[27])<<24,v=255&n[28]|(255&n[29])<<8|(255&n[30])<<16|(255&n[31])<<24,w=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,S=0;S<20;S+=2)a^=(o=(b^=(o=(h^=(o=(c^=(o=a+b|0)<<7|o>>>25)+a|0)<<9|o>>>23)+c|0)<<13|o>>>19)+h|0)<<18|o>>>14,d^=(o=(s^=(o=(g^=(o=(f^=(o=d+s|0)<<7|o>>>25)+d|0)<<9|o>>>23)+f|0)<<13|o>>>19)+g|0)<<18|o>>>14,y^=(o=(u^=(o=(i^=(o=(v^=(o=y+u|0)<<7|o>>>25)+y|0)<<9|o>>>23)+v|0)<<13|o>>>19)+i|0)<<18|o>>>14,w^=(o=(m^=(o=(p^=(o=(l^=(o=w+m|0)<<7|o>>>25)+w|0)<<9|o>>>23)+l|0)<<13|o>>>19)+p|0)<<18|o>>>14,a^=(o=(l^=(o=(i^=(o=(s^=(o=a+l|0)<<7|o>>>25)+a|0)<<9|o>>>23)+s|0)<<13|o>>>19)+i|0)<<18|o>>>14,d^=(o=(c^=(o=(p^=(o=(u^=(o=d+c|0)<<7|o>>>25)+d|0)<<9|o>>>23)+u|0)<<13|o>>>19)+p|0)<<18|o>>>14,y^=(o=(f^=(o=(h^=(o=(m^=(o=y+f|0)<<7|o>>>25)+y|0)<<9|o>>>23)+m|0)<<13|o>>>19)+h|0)<<18|o>>>14,w^=(o=(v^=(o=(g^=(o=(b^=(o=w+v|0)<<7|o>>>25)+w|0)<<9|o>>>23)+b|0)<<13|o>>>19)+g|0)<<18|o>>>14;e[0]=a>>>0&255,e[1]=a>>>8&255,e[2]=a>>>16&255,e[3]=a>>>24&255,e[4]=d>>>0&255,e[5]=d>>>8&255,e[6]=d>>>16&255,e[7]=d>>>24&255,e[8]=y>>>0&255,e[9]=y>>>8&255,e[10]=y>>>16&255,e[11]=y>>>24&255,e[12]=w>>>0&255,e[13]=w>>>8&255,e[14]=w>>>16&255,e[15]=w>>>24&255,e[16]=u>>>0&255,e[17]=u>>>8&255,e[18]=u>>>16&255,e[19]=u>>>24&255,e[20]=p>>>0&255,e[21]=p>>>8&255,e[22]=p>>>16&255,e[23]=p>>>24&255,e[24]=h>>>0&255,e[25]=h>>>8&255,e[26]=h>>>16&255,e[27]=h>>>24&255,e[28]=f>>>0&255,e[29]=f>>>8&255,e[30]=f>>>16&255,e[31]=f>>>24&255}(e,t,n,r)}var v=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function w(e,t,n,r,o,a,s){var i,l,c=new Uint8Array(16),d=new Uint8Array(64);for(l=0;l<16;l++)c[l]=0;for(l=0;l<8;l++)c[l]=a[l];for(;o>=64;){for(b(d,c,s,v),l=0;l<64;l++)e[t+l]=n[r+l]^d[l];for(i=1,l=8;l<16;l++)i=i+(255&c[l])|0,c[l]=255&i,i>>>=8;o-=64,t+=64,r+=64}if(o>0)for(b(d,c,s,v),l=0;l<o;l++)e[t+l]=n[r+l]^d[l];return 0}function S(e,t,n,r,o){var a,s,i=new Uint8Array(16),l=new Uint8Array(64);for(s=0;s<16;s++)i[s]=0;for(s=0;s<8;s++)i[s]=r[s];for(;n>=64;){for(b(l,i,o,v),s=0;s<64;s++)e[t+s]=l[s];for(a=1,s=8;s<16;s++)a=a+(255&i[s])|0,i[s]=255&a,a>>>=8;n-=64,t+=64}if(n>0)for(b(l,i,o,v),s=0;s<n;s++)e[t+s]=l[s];return 0}function x(e,t,n,r,o){var a=new Uint8Array(32);g(a,r,o,v);for(var s=new Uint8Array(8),i=0;i<8;i++)s[i]=r[i+16];return S(e,t,n,s,a)}function k(e,t,n,r,o,a,s){var i=new Uint8Array(32);g(i,a,s,v);for(var l=new Uint8Array(8),c=0;c<8;c++)l[c]=a[c+16];return w(e,t,n,r,o,l,i)}var _=function(e){var t,n,r,o,a,s,i,l;this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0,t=255&e[0]|(255&e[1])<<8,this.r[0]=8191&t,n=255&e[2]|(255&e[3])<<8,this.r[1]=8191&(t>>>13|n<<3),r=255&e[4]|(255&e[5])<<8,this.r[2]=7939&(n>>>10|r<<6),o=255&e[6]|(255&e[7])<<8,this.r[3]=8191&(r>>>7|o<<9),a=255&e[8]|(255&e[9])<<8,this.r[4]=255&(o>>>4|a<<12),this.r[5]=a>>>1&8190,s=255&e[10]|(255&e[11])<<8,this.r[6]=8191&(a>>>14|s<<2),i=255&e[12]|(255&e[13])<<8,this.r[7]=8065&(s>>>11|i<<5),l=255&e[14]|(255&e[15])<<8,this.r[8]=8191&(i>>>8|l<<8),this.r[9]=l>>>5&127,this.pad[0]=255&e[16]|(255&e[17])<<8,this.pad[1]=255&e[18]|(255&e[19])<<8,this.pad[2]=255&e[20]|(255&e[21])<<8,this.pad[3]=255&e[22]|(255&e[23])<<8,this.pad[4]=255&e[24]|(255&e[25])<<8,this.pad[5]=255&e[26]|(255&e[27])<<8,this.pad[6]=255&e[28]|(255&e[29])<<8,this.pad[7]=255&e[30]|(255&e[31])<<8};function C(e,t,n,r,o,a){var s=new _(a);return s.update(n,r,o),s.finish(e,t),0}function P(e,t,n,r,o,a){var s=new Uint8Array(16);return C(s,0,n,r,o,a),y(e,t,s,0)}function E(e,t,n,r,o){var a;if(n<32)return-1;for(k(e,0,t,0,n,r,o),C(e,16,e,32,n-32,e),a=0;a<16;a++)e[a]=0;return 0}function A(e,t,n,r,o){var a,s=new Uint8Array(32);if(n<32)return-1;if(x(s,0,32,r,o),0!==P(t,16,t,32,n-32,s))return-1;for(k(e,0,t,0,n,r,o),a=0;a<32;a++)e[a]=0;return 0}function T(e,t){var n;for(n=0;n<16;n++)e[n]=0|t[n]}function I(e){var t,n,r=1;for(t=0;t<16;t++)n=e[t]+r+65535,r=Math.floor(n/65536),e[t]=n-65536*r;e[0]+=r-1+37*(r-1)}function D(e,t,n){for(var r,o=~(n-1),a=0;a<16;a++)r=o&(e[a]^t[a]),e[a]^=r,t[a]^=r}function R(e,n){var r,o,a,s=t(),i=t();for(r=0;r<16;r++)i[r]=n[r];for(I(i),I(i),I(i),o=0;o<2;o++){for(s[0]=i[0]-65517,r=1;r<15;r++)s[r]=i[r]-65535-(s[r-1]>>16&1),s[r-1]&=65535;s[15]=i[15]-32767-(s[14]>>16&1),a=s[15]>>16&1,s[14]&=65535,D(i,s,1-a)}for(r=0;r<16;r++)e[2*r]=255&i[r],e[2*r+1]=i[r]>>8}function N(e,t){var n=new Uint8Array(32),r=new Uint8Array(32);return R(n,e),R(r,t),m(n,0,r,0)}function $(e){var t=new Uint8Array(32);return R(t,e),1&t[0]}function W(e,t){var n;for(n=0;n<16;n++)e[n]=t[2*n]+(t[2*n+1]<<8);e[15]&=32767}function M(e,t,n){for(var r=0;r<16;r++)e[r]=t[r]+n[r]}function O(e,t,n){for(var r=0;r<16;r++)e[r]=t[r]-n[r]}function B(e,t,n){var r,o,a=0,s=0,i=0,l=0,c=0,d=0,u=0,p=0,h=0,f=0,y=0,m=0,b=0,g=0,v=0,w=0,S=0,x=0,k=0,_=0,C=0,P=0,E=0,A=0,T=0,I=0,D=0,R=0,N=0,$=0,W=0,M=n[0],O=n[1],B=n[2],J=n[3],U=n[4],L=n[5],F=n[6],H=n[7],j=n[8],K=n[9],V=n[10],z=n[11],q=n[12],G=n[13],X=n[14],Y=n[15];a+=(r=t[0])*M,s+=r*O,i+=r*B,l+=r*J,c+=r*U,d+=r*L,u+=r*F,p+=r*H,h+=r*j,f+=r*K,y+=r*V,m+=r*z,b+=r*q,g+=r*G,v+=r*X,w+=r*Y,s+=(r=t[1])*M,i+=r*O,l+=r*B,c+=r*J,d+=r*U,u+=r*L,p+=r*F,h+=r*H,f+=r*j,y+=r*K,m+=r*V,b+=r*z,g+=r*q,v+=r*G,w+=r*X,S+=r*Y,i+=(r=t[2])*M,l+=r*O,c+=r*B,d+=r*J,u+=r*U,p+=r*L,h+=r*F,f+=r*H,y+=r*j,m+=r*K,b+=r*V,g+=r*z,v+=r*q,w+=r*G,S+=r*X,x+=r*Y,l+=(r=t[3])*M,c+=r*O,d+=r*B,u+=r*J,p+=r*U,h+=r*L,f+=r*F,y+=r*H,m+=r*j,b+=r*K,g+=r*V,v+=r*z,w+=r*q,S+=r*G,x+=r*X,k+=r*Y,c+=(r=t[4])*M,d+=r*O,u+=r*B,p+=r*J,h+=r*U,f+=r*L,y+=r*F,m+=r*H,b+=r*j,g+=r*K,v+=r*V,w+=r*z,S+=r*q,x+=r*G,k+=r*X,_+=r*Y,d+=(r=t[5])*M,u+=r*O,p+=r*B,h+=r*J,f+=r*U,y+=r*L,m+=r*F,b+=r*H,g+=r*j,v+=r*K,w+=r*V,S+=r*z,x+=r*q,k+=r*G,_+=r*X,C+=r*Y,u+=(r=t[6])*M,p+=r*O,h+=r*B,f+=r*J,y+=r*U,m+=r*L,b+=r*F,g+=r*H,v+=r*j,w+=r*K,S+=r*V,x+=r*z,k+=r*q,_+=r*G,C+=r*X,P+=r*Y,p+=(r=t[7])*M,h+=r*O,f+=r*B,y+=r*J,m+=r*U,b+=r*L,g+=r*F,v+=r*H,w+=r*j,S+=r*K,x+=r*V,k+=r*z,_+=r*q,C+=r*G,P+=r*X,E+=r*Y,h+=(r=t[8])*M,f+=r*O,y+=r*B,m+=r*J,b+=r*U,g+=r*L,v+=r*F,w+=r*H,S+=r*j,x+=r*K,k+=r*V,_+=r*z,C+=r*q,P+=r*G,E+=r*X,A+=r*Y,f+=(r=t[9])*M,y+=r*O,m+=r*B,b+=r*J,g+=r*U,v+=r*L,w+=r*F,S+=r*H,x+=r*j,k+=r*K,_+=r*V,C+=r*z,P+=r*q,E+=r*G,A+=r*X,T+=r*Y,y+=(r=t[10])*M,m+=r*O,b+=r*B,g+=r*J,v+=r*U,w+=r*L,S+=r*F,x+=r*H,k+=r*j,_+=r*K,C+=r*V,P+=r*z,E+=r*q,A+=r*G,T+=r*X,I+=r*Y,m+=(r=t[11])*M,b+=r*O,g+=r*B,v+=r*J,w+=r*U,S+=r*L,x+=r*F,k+=r*H,_+=r*j,C+=r*K,P+=r*V,E+=r*z,A+=r*q,T+=r*G,I+=r*X,D+=r*Y,b+=(r=t[12])*M,g+=r*O,v+=r*B,w+=r*J,S+=r*U,x+=r*L,k+=r*F,_+=r*H,C+=r*j,P+=r*K,E+=r*V,A+=r*z,T+=r*q,I+=r*G,D+=r*X,R+=r*Y,g+=(r=t[13])*M,v+=r*O,w+=r*B,S+=r*J,x+=r*U,k+=r*L,_+=r*F,C+=r*H,P+=r*j,E+=r*K,A+=r*V,T+=r*z,I+=r*q,D+=r*G,R+=r*X,N+=r*Y,v+=(r=t[14])*M,w+=r*O,S+=r*B,x+=r*J,k+=r*U,_+=r*L,C+=r*F,P+=r*H,E+=r*j,A+=r*K,T+=r*V,I+=r*z,D+=r*q,R+=r*G,N+=r*X,$+=r*Y,w+=(r=t[15])*M,s+=38*(x+=r*B),i+=38*(k+=r*J),l+=38*(_+=r*U),c+=38*(C+=r*L),d+=38*(P+=r*F),u+=38*(E+=r*H),p+=38*(A+=r*j),h+=38*(T+=r*K),f+=38*(I+=r*V),y+=38*(D+=r*z),m+=38*(R+=r*q),b+=38*(N+=r*G),g+=38*($+=r*X),v+=38*(W+=r*Y),a=(r=(a+=38*(S+=r*O))+(o=1)+65535)-65536*(o=Math.floor(r/65536)),s=(r=s+o+65535)-65536*(o=Math.floor(r/65536)),i=(r=i+o+65535)-65536*(o=Math.floor(r/65536)),l=(r=l+o+65535)-65536*(o=Math.floor(r/65536)),c=(r=c+o+65535)-65536*(o=Math.floor(r/65536)),d=(r=d+o+65535)-65536*(o=Math.floor(r/65536)),u=(r=u+o+65535)-65536*(o=Math.floor(r/65536)),p=(r=p+o+65535)-65536*(o=Math.floor(r/65536)),h=(r=h+o+65535)-65536*(o=Math.floor(r/65536)),f=(r=f+o+65535)-65536*(o=Math.floor(r/65536)),y=(r=y+o+65535)-65536*(o=Math.floor(r/65536)),m=(r=m+o+65535)-65536*(o=Math.floor(r/65536)),b=(r=b+o+65535)-65536*(o=Math.floor(r/65536)),g=(r=g+o+65535)-65536*(o=Math.floor(r/65536)),v=(r=v+o+65535)-65536*(o=Math.floor(r/65536)),w=(r=w+o+65535)-65536*(o=Math.floor(r/65536)),a=(r=(a+=o-1+37*(o-1))+(o=1)+65535)-65536*(o=Math.floor(r/65536)),s=(r=s+o+65535)-65536*(o=Math.floor(r/65536)),i=(r=i+o+65535)-65536*(o=Math.floor(r/65536)),l=(r=l+o+65535)-65536*(o=Math.floor(r/65536)),c=(r=c+o+65535)-65536*(o=Math.floor(r/65536)),d=(r=d+o+65535)-65536*(o=Math.floor(r/65536)),u=(r=u+o+65535)-65536*(o=Math.floor(r/65536)),p=(r=p+o+65535)-65536*(o=Math.floor(r/65536)),h=(r=h+o+65535)-65536*(o=Math.floor(r/65536)),f=(r=f+o+65535)-65536*(o=Math.floor(r/65536)),y=(r=y+o+65535)-65536*(o=Math.floor(r/65536)),m=(r=m+o+65535)-65536*(o=Math.floor(r/65536)),b=(r=b+o+65535)-65536*(o=Math.floor(r/65536)),g=(r=g+o+65535)-65536*(o=Math.floor(r/65536)),v=(r=v+o+65535)-65536*(o=Math.floor(r/65536)),w=(r=w+o+65535)-65536*(o=Math.floor(r/65536)),a+=o-1+37*(o-1),e[0]=a,e[1]=s,e[2]=i,e[3]=l,e[4]=c,e[5]=d,e[6]=u,e[7]=p,e[8]=h,e[9]=f,e[10]=y,e[11]=m,e[12]=b,e[13]=g,e[14]=v,e[15]=w}function J(e,t){B(e,t,t)}function U(e,n){var r,o=t();for(r=0;r<16;r++)o[r]=n[r];for(r=253;r>=0;r--)J(o,o),2!==r&&4!==r&&B(o,o,n);for(r=0;r<16;r++)e[r]=o[r]}function L(e,n){var r,o=t();for(r=0;r<16;r++)o[r]=n[r];for(r=250;r>=0;r--)J(o,o),1!==r&&B(o,o,n);for(r=0;r<16;r++)e[r]=o[r]}function F(e,n,r){var o,a,s=new Uint8Array(32),l=new Float64Array(80),c=t(),d=t(),u=t(),p=t(),h=t(),f=t();for(a=0;a<31;a++)s[a]=n[a];for(s[31]=127&n[31]|64,s[0]&=248,W(l,r),a=0;a<16;a++)d[a]=l[a],p[a]=c[a]=u[a]=0;for(c[0]=p[0]=1,a=254;a>=0;--a)D(c,d,o=s[a>>>3]>>>(7&a)&1),D(u,p,o),M(h,c,u),O(c,c,u),M(u,d,p),O(d,d,p),J(p,h),J(f,c),B(c,u,c),B(u,d,h),M(h,c,u),O(c,c,u),J(d,c),O(u,p,f),B(c,u,i),M(c,c,p),B(u,u,c),B(c,p,f),B(p,d,l),J(d,h),D(c,d,o),D(u,p,o);for(a=0;a<16;a++)l[a+16]=c[a],l[a+32]=u[a],l[a+48]=d[a],l[a+64]=p[a];var y=l.subarray(32),m=l.subarray(16);return U(y,y),B(m,m,y),R(e,m),0}function H(e,t){return F(e,t,o)}function j(e,t){return n(t,32),H(e,t)}function K(e,t,n){var o=new Uint8Array(32);return F(o,n,t),g(e,r,o,v)}_.prototype.blocks=function(e,t,n){for(var r,o,a,s,i,l,c,d,u,p,h,f,y,m,b,g,v,w,S,x=this.fin?0:2048,k=this.h[0],_=this.h[1],C=this.h[2],P=this.h[3],E=this.h[4],A=this.h[5],T=this.h[6],I=this.h[7],D=this.h[8],R=this.h[9],N=this.r[0],$=this.r[1],W=this.r[2],M=this.r[3],O=this.r[4],B=this.r[5],J=this.r[6],U=this.r[7],L=this.r[8],F=this.r[9];n>=16;)p=u=0,p+=(k+=8191&(r=255&e[t+0]|(255&e[t+1])<<8))*N,p+=(_+=8191&(r>>>13|(o=255&e[t+2]|(255&e[t+3])<<8)<<3))*(5*F),p+=(C+=8191&(o>>>10|(a=255&e[t+4]|(255&e[t+5])<<8)<<6))*(5*L),p+=(P+=8191&(a>>>7|(s=255&e[t+6]|(255&e[t+7])<<8)<<9))*(5*U),u=(p+=(E+=8191&(s>>>4|(i=255&e[t+8]|(255&e[t+9])<<8)<<12))*(5*J))>>>13,p&=8191,p+=(A+=i>>>1&8191)*(5*B),p+=(T+=8191&(i>>>14|(l=255&e[t+10]|(255&e[t+11])<<8)<<2))*(5*O),p+=(I+=8191&(l>>>11|(c=255&e[t+12]|(255&e[t+13])<<8)<<5))*(5*M),p+=(D+=8191&(c>>>8|(d=255&e[t+14]|(255&e[t+15])<<8)<<8))*(5*W),h=u+=(p+=(R+=d>>>5|x)*(5*$))>>>13,h+=k*$,h+=_*N,h+=C*(5*F),h+=P*(5*L),u=(h+=E*(5*U))>>>13,h&=8191,h+=A*(5*J),h+=T*(5*B),h+=I*(5*O),h+=D*(5*M),u+=(h+=R*(5*W))>>>13,h&=8191,f=u,f+=k*W,f+=_*$,f+=C*N,f+=P*(5*F),u=(f+=E*(5*L))>>>13,f&=8191,f+=A*(5*U),f+=T*(5*J),f+=I*(5*B),f+=D*(5*O),y=u+=(f+=R*(5*M))>>>13,y+=k*M,y+=_*W,y+=C*$,y+=P*N,u=(y+=E*(5*F))>>>13,y&=8191,y+=A*(5*L),y+=T*(5*U),y+=I*(5*J),y+=D*(5*B),m=u+=(y+=R*(5*O))>>>13,m+=k*O,m+=_*M,m+=C*W,m+=P*$,u=(m+=E*N)>>>13,m&=8191,m+=A*(5*F),m+=T*(5*L),m+=I*(5*U),m+=D*(5*J),b=u+=(m+=R*(5*B))>>>13,b+=k*B,b+=_*O,b+=C*M,b+=P*W,u=(b+=E*$)>>>13,b&=8191,b+=A*N,b+=T*(5*F),b+=I*(5*L),b+=D*(5*U),g=u+=(b+=R*(5*J))>>>13,g+=k*J,g+=_*B,g+=C*O,g+=P*M,u=(g+=E*W)>>>13,g&=8191,g+=A*$,g+=T*N,g+=I*(5*F),g+=D*(5*L),v=u+=(g+=R*(5*U))>>>13,v+=k*U,v+=_*J,v+=C*B,v+=P*O,u=(v+=E*M)>>>13,v&=8191,v+=A*W,v+=T*$,v+=I*N,v+=D*(5*F),w=u+=(v+=R*(5*L))>>>13,w+=k*L,w+=_*U,w+=C*J,w+=P*B,u=(w+=E*O)>>>13,w&=8191,w+=A*M,w+=T*W,w+=I*$,w+=D*N,S=u+=(w+=R*(5*F))>>>13,S+=k*F,S+=_*L,S+=C*U,S+=P*J,u=(S+=E*B)>>>13,S&=8191,S+=A*O,S+=T*M,S+=I*W,S+=D*$,k=p=8191&(u=(u=((u+=(S+=R*N)>>>13)<<2)+u|0)+(p&=8191)|0),_=h+=u>>>=13,C=f&=8191,P=y&=8191,E=m&=8191,A=b&=8191,T=g&=8191,I=v&=8191,D=w&=8191,R=S&=8191,t+=16,n-=16;this.h[0]=k,this.h[1]=_,this.h[2]=C,this.h[3]=P,this.h[4]=E,this.h[5]=A,this.h[6]=T,this.h[7]=I,this.h[8]=D,this.h[9]=R},_.prototype.finish=function(e,t){var n,r,o,a,s=new Uint16Array(10);if(this.leftover){for(a=this.leftover,this.buffer[a++]=1;a<16;a++)this.buffer[a]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(n=this.h[1]>>>13,this.h[1]&=8191,a=2;a<10;a++)this.h[a]+=n,n=this.h[a]>>>13,this.h[a]&=8191;for(this.h[0]+=5*n,n=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=n,n=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=n,s[0]=this.h[0]+5,n=s[0]>>>13,s[0]&=8191,a=1;a<10;a++)s[a]=this.h[a]+n,n=s[a]>>>13,s[a]&=8191;for(s[9]-=8192,r=(1^n)-1,a=0;a<10;a++)s[a]&=r;for(r=~r,a=0;a<10;a++)this.h[a]=this.h[a]&r|s[a];for(this.h[0]=65535&(this.h[0]|this.h[1]<<13),this.h[1]=65535&(this.h[1]>>>3|this.h[2]<<10),this.h[2]=65535&(this.h[2]>>>6|this.h[3]<<7),this.h[3]=65535&(this.h[3]>>>9|this.h[4]<<4),this.h[4]=65535&(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14),this.h[5]=65535&(this.h[6]>>>2|this.h[7]<<11),this.h[6]=65535&(this.h[7]>>>5|this.h[8]<<8),this.h[7]=65535&(this.h[8]>>>8|this.h[9]<<5),o=this.h[0]+this.pad[0],this.h[0]=65535&o,a=1;a<8;a++)o=(this.h[a]+this.pad[a]|0)+(o>>>16)|0,this.h[a]=65535&o;e[t+0]=this.h[0]>>>0&255,e[t+1]=this.h[0]>>>8&255,e[t+2]=this.h[1]>>>0&255,e[t+3]=this.h[1]>>>8&255,e[t+4]=this.h[2]>>>0&255,e[t+5]=this.h[2]>>>8&255,e[t+6]=this.h[3]>>>0&255,e[t+7]=this.h[3]>>>8&255,e[t+8]=this.h[4]>>>0&255,e[t+9]=this.h[4]>>>8&255,e[t+10]=this.h[5]>>>0&255,e[t+11]=this.h[5]>>>8&255,e[t+12]=this.h[6]>>>0&255,e[t+13]=this.h[6]>>>8&255,e[t+14]=this.h[7]>>>0&255,e[t+15]=this.h[7]>>>8&255},_.prototype.update=function(e,t,n){var r,o;if(this.leftover){for((o=16-this.leftover)>n&&(o=n),r=0;r<o;r++)this.buffer[this.leftover+r]=e[t+r];if(n-=o,t+=o,this.leftover+=o,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(n>=16&&(o=n-n%16,this.blocks(e,t,o),t+=o,n-=o),n){for(r=0;r<n;r++)this.buffer[this.leftover+r]=e[t+r];this.leftover+=n}};var V=E,z=A;var q=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function G(e,t,n,r){for(var o,a,s,i,l,c,d,u,p,h,f,y,m,b,g,v,w,S,x,k,_,C,P,E,A,T,I=new Int32Array(16),D=new Int32Array(16),R=e[0],N=e[1],$=e[2],W=e[3],M=e[4],O=e[5],B=e[6],J=e[7],U=t[0],L=t[1],F=t[2],H=t[3],j=t[4],K=t[5],V=t[6],z=t[7],G=0;r>=128;){for(x=0;x<16;x++)k=8*x+G,I[x]=n[k+0]<<24|n[k+1]<<16|n[k+2]<<8|n[k+3],D[x]=n[k+4]<<24|n[k+5]<<16|n[k+6]<<8|n[k+7];for(x=0;x<80;x++)if(o=R,a=N,s=$,i=W,l=M,c=O,d=B,J,p=U,h=L,f=F,y=H,m=j,b=K,g=V,z,P=65535&(C=z),E=C>>>16,A=65535&(_=J),T=_>>>16,P+=65535&(C=(j>>>14|M<<18)^(j>>>18|M<<14)^(M>>>9|j<<23)),E+=C>>>16,A+=65535&(_=(M>>>14|j<<18)^(M>>>18|j<<14)^(j>>>9|M<<23)),T+=_>>>16,P+=65535&(C=j&K^~j&V),E+=C>>>16,A+=65535&(_=M&O^~M&B),T+=_>>>16,P+=65535&(C=q[2*x+1]),E+=C>>>16,A+=65535&(_=q[2*x]),T+=_>>>16,_=I[x%16],E+=(C=D[x%16])>>>16,A+=65535&_,T+=_>>>16,A+=(E+=(P+=65535&C)>>>16)>>>16,P=65535&(C=S=65535&P|E<<16),E=C>>>16,A=65535&(_=w=65535&A|(T+=A>>>16)<<16),T=_>>>16,P+=65535&(C=(U>>>28|R<<4)^(R>>>2|U<<30)^(R>>>7|U<<25)),E+=C>>>16,A+=65535&(_=(R>>>28|U<<4)^(U>>>2|R<<30)^(U>>>7|R<<25)),T+=_>>>16,E+=(C=U&L^U&F^L&F)>>>16,A+=65535&(_=R&N^R&$^N&$),T+=_>>>16,u=65535&(A+=(E+=(P+=65535&C)>>>16)>>>16)|(T+=A>>>16)<<16,v=65535&P|E<<16,P=65535&(C=y),E=C>>>16,A=65535&(_=i),T=_>>>16,E+=(C=S)>>>16,A+=65535&(_=w),T+=_>>>16,N=o,$=a,W=s,M=i=65535&(A+=(E+=(P+=65535&C)>>>16)>>>16)|(T+=A>>>16)<<16,O=l,B=c,J=d,R=u,L=p,F=h,H=f,j=y=65535&P|E<<16,K=m,V=b,z=g,U=v,x%16==15)for(k=0;k<16;k++)_=I[k],P=65535&(C=D[k]),E=C>>>16,A=65535&_,T=_>>>16,_=I[(k+9)%16],P+=65535&(C=D[(k+9)%16]),E+=C>>>16,A+=65535&_,T+=_>>>16,w=I[(k+1)%16],P+=65535&(C=((S=D[(k+1)%16])>>>1|w<<31)^(S>>>8|w<<24)^(S>>>7|w<<25)),E+=C>>>16,A+=65535&(_=(w>>>1|S<<31)^(w>>>8|S<<24)^w>>>7),T+=_>>>16,w=I[(k+14)%16],E+=(C=((S=D[(k+14)%16])>>>19|w<<13)^(w>>>29|S<<3)^(S>>>6|w<<26))>>>16,A+=65535&(_=(w>>>19|S<<13)^(S>>>29|w<<3)^w>>>6),T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,I[k]=65535&A|T<<16,D[k]=65535&P|E<<16;P=65535&(C=U),E=C>>>16,A=65535&(_=R),T=_>>>16,_=e[0],E+=(C=t[0])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[0]=R=65535&A|T<<16,t[0]=U=65535&P|E<<16,P=65535&(C=L),E=C>>>16,A=65535&(_=N),T=_>>>16,_=e[1],E+=(C=t[1])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[1]=N=65535&A|T<<16,t[1]=L=65535&P|E<<16,P=65535&(C=F),E=C>>>16,A=65535&(_=$),T=_>>>16,_=e[2],E+=(C=t[2])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[2]=$=65535&A|T<<16,t[2]=F=65535&P|E<<16,P=65535&(C=H),E=C>>>16,A=65535&(_=W),T=_>>>16,_=e[3],E+=(C=t[3])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[3]=W=65535&A|T<<16,t[3]=H=65535&P|E<<16,P=65535&(C=j),E=C>>>16,A=65535&(_=M),T=_>>>16,_=e[4],E+=(C=t[4])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[4]=M=65535&A|T<<16,t[4]=j=65535&P|E<<16,P=65535&(C=K),E=C>>>16,A=65535&(_=O),T=_>>>16,_=e[5],E+=(C=t[5])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[5]=O=65535&A|T<<16,t[5]=K=65535&P|E<<16,P=65535&(C=V),E=C>>>16,A=65535&(_=B),T=_>>>16,_=e[6],E+=(C=t[6])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[6]=B=65535&A|T<<16,t[6]=V=65535&P|E<<16,P=65535&(C=z),E=C>>>16,A=65535&(_=J),T=_>>>16,_=e[7],E+=(C=t[7])>>>16,A+=65535&_,T+=_>>>16,T+=(A+=(E+=(P+=65535&C)>>>16)>>>16)>>>16,e[7]=J=65535&A|T<<16,t[7]=z=65535&P|E<<16,G+=128,r-=128}return r}function X(e,t,n){var r,o=new Int32Array(8),a=new Int32Array(8),s=new Uint8Array(256),i=n;for(o[0]=1779033703,o[1]=3144134277,o[2]=1013904242,o[3]=2773480762,o[4]=1359893119,o[5]=2600822924,o[6]=528734635,o[7]=1541459225,a[0]=4089235720,a[1]=2227873595,a[2]=4271175723,a[3]=1595750129,a[4]=2917565137,a[5]=725511199,a[6]=4215389547,a[7]=327033209,G(o,a,t,n),n%=128,r=0;r<n;r++)s[r]=t[i-n+r];for(s[n]=128,s[(n=256-128*(n<112?1:0))-9]=0,h(s,n-8,i/536870912|0,i<<3),G(o,a,s,n),r=0;r<8;r++)h(e,8*r,o[r],a[r]);return 0}function Y(e,n){var r=t(),o=t(),a=t(),s=t(),i=t(),l=t(),d=t(),u=t(),p=t();O(r,e[1],e[0]),O(p,n[1],n[0]),B(r,r,p),M(o,e[0],e[1]),M(p,n[0],n[1]),B(o,o,p),B(a,e[3],n[3]),B(a,a,c),B(s,e[2],n[2]),M(s,s,s),O(i,o,r),O(l,s,a),M(d,s,a),M(u,o,r),B(e[0],i,l),B(e[1],u,d),B(e[2],d,l),B(e[3],i,u)}function Q(e,t,n){var r;for(r=0;r<4;r++)D(e[r],t[r],n)}function Z(e,n){var r=t(),o=t(),a=t();U(a,n[2]),B(r,n[0],a),B(o,n[1],a),R(e,o),e[31]^=$(r)<<7}function ee(e,t,n){var r,o;for(T(e[0],a),T(e[1],s),T(e[2],s),T(e[3],a),o=255;o>=0;--o)Q(e,t,r=n[o/8|0]>>(7&o)&1),Y(t,e),Y(e,e),Q(e,t,r)}function te(e,n){var r=[t(),t(),t(),t()];T(r[0],d),T(r[1],u),T(r[2],s),B(r[3],d,u),ee(e,r,n)}function ne(e,r,o){var a,s=new Uint8Array(64),i=[t(),t(),t(),t()];for(o||n(r,32),X(s,r,32),s[0]&=248,s[31]&=127,s[31]|=64,te(i,s),Z(e,i),a=0;a<32;a++)r[a+32]=e[a];return 0}var re=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function oe(e,t){var n,r,o,a;for(r=63;r>=32;--r){for(n=0,o=r-32,a=r-12;o<a;++o)t[o]+=n-16*t[r]*re[o-(r-32)],n=Math.floor((t[o]+128)/256),t[o]-=256*n;t[o]+=n,t[r]=0}for(n=0,o=0;o<32;o++)t[o]+=n-(t[31]>>4)*re[o],n=t[o]>>8,t[o]&=255;for(o=0;o<32;o++)t[o]-=n*re[o];for(r=0;r<32;r++)t[r+1]+=t[r]>>8,e[r]=255&t[r]}function ae(e){var t,n=new Float64Array(64);for(t=0;t<64;t++)n[t]=e[t];for(t=0;t<64;t++)e[t]=0;oe(e,n)}function se(e,n,r,o){var a,s,i=new Uint8Array(64),l=new Uint8Array(64),c=new Uint8Array(64),d=new Float64Array(64),u=[t(),t(),t(),t()];X(i,o,32),i[0]&=248,i[31]&=127,i[31]|=64;var p=r+64;for(a=0;a<r;a++)e[64+a]=n[a];for(a=0;a<32;a++)e[32+a]=i[32+a];for(X(c,e.subarray(32),r+32),ae(c),te(u,c),Z(e,u),a=32;a<64;a++)e[a]=o[a];for(X(l,e,r+64),ae(l),a=0;a<64;a++)d[a]=0;for(a=0;a<32;a++)d[a]=c[a];for(a=0;a<32;a++)for(s=0;s<32;s++)d[a+s]+=l[a]*i[s];return oe(e.subarray(32),d),p}function ie(e,n,r,o){var i,c=new Uint8Array(32),d=new Uint8Array(64),u=[t(),t(),t(),t()],h=[t(),t(),t(),t()];if(r<64)return-1;if(function(e,n){var r=t(),o=t(),i=t(),c=t(),d=t(),u=t(),h=t();return T(e[2],s),W(e[1],n),J(i,e[1]),B(c,i,l),O(i,i,e[2]),M(c,e[2],c),J(d,c),J(u,d),B(h,u,d),B(r,h,i),B(r,r,c),L(r,r),B(r,r,i),B(r,r,c),B(r,r,c),B(e[0],r,c),J(o,e[0]),B(o,o,c),N(o,i)&&B(e[0],e[0],p),J(o,e[0]),B(o,o,c),N(o,i)?-1:($(e[0])===n[31]>>7&&O(e[0],a,e[0]),B(e[3],e[0],e[1]),0)}(h,o))return-1;for(i=0;i<r;i++)e[i]=n[i];for(i=0;i<32;i++)e[i+32]=o[i];if(X(d,e,r),ae(d),ee(u,h,d),te(h,n.subarray(32)),Y(u,h),Z(c,u),r-=64,m(n,0,c,0)){for(i=0;i<r;i++)e[i]=0;return-1}for(i=0;i<r;i++)e[i]=n[i+64];return r}var le=16,ce=64,de=32,ue=64;function pe(e,t){if(32!==e.length)throw new Error("bad key size");if(24!==t.length)throw new Error("bad nonce size")}function he(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function fe(e){for(var t=0;t<e.length;t++)e[t]=0}e.lowlevel={crypto_core_hsalsa20:g,crypto_stream_xor:k,crypto_stream:x,crypto_stream_salsa20_xor:w,crypto_stream_salsa20:S,crypto_onetimeauth:C,crypto_onetimeauth_verify:P,crypto_verify_16:y,crypto_verify_32:m,crypto_secretbox:E,crypto_secretbox_open:A,crypto_scalarmult:F,crypto_scalarmult_base:H,crypto_box_beforenm:K,crypto_box_afternm:V,crypto_box:function(e,t,n,r,o,a){var s=new Uint8Array(32);return K(s,o,a),V(e,t,n,r,s)},crypto_box_open:function(e,t,n,r,o,a){var s=new Uint8Array(32);return K(s,o,a),z(e,t,n,r,s)},crypto_box_keypair:j,crypto_hash:X,crypto_sign:se,crypto_sign_keypair:ne,crypto_sign_open:ie,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:le,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:ce,crypto_sign_PUBLICKEYBYTES:de,crypto_sign_SECRETKEYBYTES:ue,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:t,D:l,L:re,pack25519:R,unpack25519:W,M:B,A:M,S:J,Z:O,pow2523:L,add:Y,set25519:T,modL:oe,scalarmult:ee,scalarbase:te},e.randomBytes=function(e){var t=new Uint8Array(e);return n(t,e),t},e.secretbox=function(e,t,n){he(e,t,n),pe(n,t);for(var r=new Uint8Array(32+e.length),o=new Uint8Array(r.length),a=0;a<e.length;a++)r[a+32]=e[a];return E(o,r,r.length,t,n),o.subarray(le)},e.secretbox.open=function(e,t,n){he(e,t,n),pe(n,t);for(var r=new Uint8Array(le+e.length),o=new Uint8Array(r.length),a=0;a<e.length;a++)r[a+le]=e[a];return r.length<32||0!==A(o,r,r.length,t,n)?null:o.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=le,e.scalarMult=function(e,t){if(he(e,t),32!==e.length)throw new Error("bad n size");if(32!==t.length)throw new Error("bad p size");var n=new Uint8Array(32);return F(n,e,t),n},e.scalarMult.base=function(e){if(he(e),32!==e.length)throw new Error("bad n size");var t=new Uint8Array(32);return H(t,e),t},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(t,n,r,o){var a=e.box.before(r,o);return e.secretbox(t,n,a)},e.box.before=function(e,t){he(e,t),function(e,t){if(32!==e.length)throw new Error("bad public key size");if(32!==t.length)throw new Error("bad secret key size")}(e,t);var n=new Uint8Array(32);return K(n,e,t),n},e.box.after=e.secretbox,e.box.open=function(t,n,r,o){var a=e.box.before(r,o);return e.secretbox.open(t,n,a)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(32);return j(e,t),{publicKey:e,secretKey:t}},e.box.keyPair.fromSecretKey=function(e){if(he(e),32!==e.length)throw new Error("bad secret key size");var t=new Uint8Array(32);return H(t,e),{publicKey:t,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,t){if(he(e,t),t.length!==ue)throw new Error("bad secret key size");var n=new Uint8Array(ce+e.length);return se(n,e,e.length,t),n},e.sign.open=function(e,t){if(he(e,t),t.length!==de)throw new Error("bad public key size");var n=new Uint8Array(e.length),r=ie(n,e,e.length,t);if(r<0)return null;for(var o=new Uint8Array(r),a=0;a<o.length;a++)o[a]=n[a];return o},e.sign.detached=function(t,n){for(var r=e.sign(t,n),o=new Uint8Array(ce),a=0;a<o.length;a++)o[a]=r[a];return o},e.sign.detached.verify=function(e,t,n){if(he(e,t,n),t.length!==ce)throw new Error("bad signature size");if(n.length!==de)throw new Error("bad public key size");var r,o=new Uint8Array(ce+e.length),a=new Uint8Array(ce+e.length);for(r=0;r<ce;r++)o[r]=t[r];for(r=0;r<e.length;r++)o[r+ce]=e[r];return ie(a,o,o.length,n)>=0},e.sign.keyPair=function(){var e=new Uint8Array(de),t=new Uint8Array(ue);return ne(e,t),{publicKey:e,secretKey:t}},e.sign.keyPair.fromSecretKey=function(e){if(he(e),e.length!==ue)throw new Error("bad secret key size");for(var t=new Uint8Array(de),n=0;n<t.length;n++)t[n]=e[32+n];return{publicKey:t,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(he(e),32!==e.length)throw new Error("bad seed size");for(var t=new Uint8Array(de),n=new Uint8Array(ue),r=0;r<32;r++)n[r]=e[r];return ne(t,n,!0),{publicKey:t,secretKey:n}},e.sign.publicKeyLength=de,e.sign.secretKeyLength=ue,e.sign.seedLength=32,e.sign.signatureLength=ce,e.hash=function(e){he(e);var t=new Uint8Array(64);return X(t,e,e.length),t},e.hash.hashLength=64,e.verify=function(e,t){return he(e,t),0!==e.length&&0!==t.length&&(e.length===t.length&&0===f(e,0,t,0,e.length))},e.setPRNG=function(e){n=e},function(){var t="undefined"!=typeof self?self.crypto||self.msCrypto:null;if(t&&t.getRandomValues){e.setPRNG((function(e,n){var r,o=new Uint8Array(n);for(r=0;r<n;r+=65536)t.getRandomValues(o.subarray(r,r+Math.min(n-r,65536)));for(r=0;r<n;r++)e[r]=o[r];fe(o)}))}else void 0!==__require&&(t=require_crypto())&&t.randomBytes&&e.setPRNG((function(e,n){var r,o=t.randomBytes(n);for(r=0;r<n;r++)e[r]=o[r];fe(o)}))}()}(void 0!==t&&t.exports?t.exports:self.nacl=self.nacl||{})}}),require_buffer=__commonJS({"(disabled):buffer"(){}}),require_sha256=__commonJS({"node_modules/js-sha256/src/sha256.js"(e,t){!function(){"use strict";var e="input is invalid type",n="object"==typeof window,r=n?window:{};r.JS_SHA256_NO_WINDOW&&(n=!1);var o=!n&&"object"==typeof self,a=!r.JS_SHA256_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;a?r=global:o&&(r=self);var s=!r.JS_SHA256_NO_COMMON_JS&&"object"==typeof t&&t.exports,i="function"==typeof define&&define.amd,l=!r.JS_SHA256_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,c="0123456789abcdef".split(""),d=[-2147483648,8388608,32768,128],u=[24,16,8,0],p=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],h=["hex","array","digest","arrayBuffer"],f=[];!r.JS_SHA256_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!l||!r.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var y=function(e,t){return function(n){return new w(t,!0).update(n)[e]()}},m=function(e){var t=y("hex",e);a&&(t=b(t,e)),t.create=function(){return new w(e)},t.update=function(e){return t.create().update(e)};for(var n=0;n<h.length;++n){var r=h[n];t[r]=y(r,e)}return t},b=function(t,n){var o,a=require_crypto(),s=require_buffer().Buffer,i=n?"sha224":"sha256";o=s.from&&!r.JS_SHA256_NO_BUFFER_FROM?s.from:function(e){return new s(e)};return function(n){if("string"==typeof n)return a.createHash(i).update(n,"utf8").digest("hex");if(null==n)throw new Error(e);return n.constructor===ArrayBuffer&&(n=new Uint8Array(n)),Array.isArray(n)||ArrayBuffer.isView(n)||n.constructor===s?a.createHash(i).update(o(n)).digest("hex"):t(n)}},g=function(e,t){return function(n,r){return new S(n,t,!0).update(r)[e]()}},v=function(e){var t=g("hex",e);t.create=function(t){return new S(t,e)},t.update=function(e,n){return t.create(e).update(n)};for(var n=0;n<h.length;++n){var r=h[n];t[r]=g(r,e)}return t};function w(e,t){t?(f[0]=f[16]=f[1]=f[2]=f[3]=f[4]=f[5]=f[6]=f[7]=f[8]=f[9]=f[10]=f[11]=f[12]=f[13]=f[14]=f[15]=0,this.blocks=f):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}function S(t,n,r){var o,a=typeof t;if("string"===a){var s,i=[],c=t.length,d=0;for(o=0;o<c;++o)(s=t.charCodeAt(o))<128?i[d++]=s:s<2048?(i[d++]=192|s>>>6,i[d++]=128|63&s):s<55296||s>=57344?(i[d++]=224|s>>>12,i[d++]=128|s>>>6&63,i[d++]=128|63&s):(s=65536+((1023&s)<<10|1023&t.charCodeAt(++o)),i[d++]=240|s>>>18,i[d++]=128|s>>>12&63,i[d++]=128|s>>>6&63,i[d++]=128|63&s);t=i}else{if("object"!==a)throw new Error(e);if(null===t)throw new Error(e);if(l&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||l&&ArrayBuffer.isView(t)))throw new Error(e)}t.length>64&&(t=new w(n,!0).update(t).array());var u=[],p=[];for(o=0;o<64;++o){var h=t[o]||0;u[o]=92^h,p[o]=54^h}w.call(this,n,r),this.update(p),this.oKeyPad=u,this.inner=!0,this.sharedMemory=r}w.prototype.update=function(t){if(!this.finalized){var n,r=typeof t;if("string"!==r){if("object"!==r)throw new Error(e);if(null===t)throw new Error(e);if(l&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||l&&ArrayBuffer.isView(t)))throw new Error(e);n=!0}for(var o,a,s=0,i=t.length,c=this.blocks;s<i;){if(this.hashed&&(this.hashed=!1,c[0]=this.block,this.block=c[16]=c[1]=c[2]=c[3]=c[4]=c[5]=c[6]=c[7]=c[8]=c[9]=c[10]=c[11]=c[12]=c[13]=c[14]=c[15]=0),n)for(a=this.start;s<i&&a<64;++s)c[a>>>2]|=t[s]<<u[3&a++];else for(a=this.start;s<i&&a<64;++s)(o=t.charCodeAt(s))<128?c[a>>>2]|=o<<u[3&a++]:o<2048?(c[a>>>2]|=(192|o>>>6)<<u[3&a++],c[a>>>2]|=(128|63&o)<<u[3&a++]):o<55296||o>=57344?(c[a>>>2]|=(224|o>>>12)<<u[3&a++],c[a>>>2]|=(128|o>>>6&63)<<u[3&a++],c[a>>>2]|=(128|63&o)<<u[3&a++]):(o=65536+((1023&o)<<10|1023&t.charCodeAt(++s)),c[a>>>2]|=(240|o>>>18)<<u[3&a++],c[a>>>2]|=(128|o>>>12&63)<<u[3&a++],c[a>>>2]|=(128|o>>>6&63)<<u[3&a++],c[a>>>2]|=(128|63&o)<<u[3&a++]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=c[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},w.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=d[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},w.prototype.hash=function(){var e,t,n,r,o,a,s,i,l,c=this.h0,d=this.h1,u=this.h2,h=this.h3,f=this.h4,y=this.h5,m=this.h6,b=this.h7,g=this.blocks;for(e=16;e<64;++e)t=((o=g[e-15])>>>7|o<<25)^(o>>>18|o<<14)^o>>>3,n=((o=g[e-2])>>>17|o<<15)^(o>>>19|o<<13)^o>>>10,g[e]=g[e-16]+t+g[e-7]+n|0;for(l=d&u,e=0;e<64;e+=4)this.first?(this.is224?(a=300032,b=(o=g[0]-1413257819)-150054599|0,h=o+24177077|0):(a=704751109,b=(o=g[0]-210244248)-1521486534|0,h=o+143694565|0),this.first=!1):(t=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),r=(a=c&d)^c&u^l,b=h+(o=b+(n=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(f&y^~f&m)+p[e]+g[e])|0,h=o+(t+r)|0),t=(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),r=(s=h&c)^h&d^a,m=u+(o=m+(n=(b>>>6|b<<26)^(b>>>11|b<<21)^(b>>>25|b<<7))+(b&f^~b&y)+p[e+1]+g[e+1])|0,t=((u=o+(t+r)|0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),r=(i=u&h)^u&c^s,y=d+(o=y+(n=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&b^~m&f)+p[e+2]+g[e+2])|0,t=((d=o+(t+r)|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),r=(l=d&u)^d&h^i,f=c+(o=f+(n=(y>>>6|y<<26)^(y>>>11|y<<21)^(y>>>25|y<<7))+(y&m^~y&b)+p[e+3]+g[e+3])|0,c=o+(t+r)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+c|0,this.h1=this.h1+d|0,this.h2=this.h2+u|0,this.h3=this.h3+h|0,this.h4=this.h4+f|0,this.h5=this.h5+y|0,this.h6=this.h6+m|0,this.h7=this.h7+b|0},w.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,o=this.h4,a=this.h5,s=this.h6,i=this.h7,l=c[e>>>28&15]+c[e>>>24&15]+c[e>>>20&15]+c[e>>>16&15]+c[e>>>12&15]+c[e>>>8&15]+c[e>>>4&15]+c[15&e]+c[t>>>28&15]+c[t>>>24&15]+c[t>>>20&15]+c[t>>>16&15]+c[t>>>12&15]+c[t>>>8&15]+c[t>>>4&15]+c[15&t]+c[n>>>28&15]+c[n>>>24&15]+c[n>>>20&15]+c[n>>>16&15]+c[n>>>12&15]+c[n>>>8&15]+c[n>>>4&15]+c[15&n]+c[r>>>28&15]+c[r>>>24&15]+c[r>>>20&15]+c[r>>>16&15]+c[r>>>12&15]+c[r>>>8&15]+c[r>>>4&15]+c[15&r]+c[o>>>28&15]+c[o>>>24&15]+c[o>>>20&15]+c[o>>>16&15]+c[o>>>12&15]+c[o>>>8&15]+c[o>>>4&15]+c[15&o]+c[a>>>28&15]+c[a>>>24&15]+c[a>>>20&15]+c[a>>>16&15]+c[a>>>12&15]+c[a>>>8&15]+c[a>>>4&15]+c[15&a]+c[s>>>28&15]+c[s>>>24&15]+c[s>>>20&15]+c[s>>>16&15]+c[s>>>12&15]+c[s>>>8&15]+c[s>>>4&15]+c[15&s];return this.is224||(l+=c[i>>>28&15]+c[i>>>24&15]+c[i>>>20&15]+c[i>>>16&15]+c[i>>>12&15]+c[i>>>8&15]+c[i>>>4&15]+c[15&i]),l},w.prototype.toString=w.prototype.hex,w.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,o=this.h4,a=this.h5,s=this.h6,i=this.h7,l=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n>>>24&255,n>>>16&255,n>>>8&255,255&n,r>>>24&255,r>>>16&255,r>>>8&255,255&r,o>>>24&255,o>>>16&255,o>>>8&255,255&o,a>>>24&255,a>>>16&255,a>>>8&255,255&a,s>>>24&255,s>>>16&255,s>>>8&255,255&s];return this.is224||l.push(i>>>24&255,i>>>16&255,i>>>8&255,255&i),l},w.prototype.array=w.prototype.digest,w.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},S.prototype=new w,S.prototype.finalize=function(){if(w.prototype.finalize.call(this),this.inner){this.inner=!1;var e=this.array();w.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(e),w.prototype.finalize.call(this)}};var x=m();x.sha256=x,x.sha224=m(!0),x.sha256.hmac=v(),x.sha224.hmac=v(!0),s?t.exports=x:(r.sha256=x.sha256,r.sha224=x.sha224,i&&define((function(){return x})))}()}}),import_tweetnacl=__toESM(require_nacl_fast()),import_js_sha256=__toESM(require_sha256());import{connect}from"cloudflare:sockets";var webcrypto_default=crypto,isCryptoKey=e=>e instanceof CryptoKey,encoder=new TextEncoder,decoder=new TextDecoder,MAX_INT32=2**32;function concat(...e){const t=e.reduce(((e,{length:t})=>e+t),0),n=new Uint8Array(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}var encodeBase64=e=>{let t=e;"string"==typeof t&&(t=encoder.encode(t));const n=[];for(let e=0;e<t.length;e+=32768)n.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return btoa(n.join(""))},encode=e=>encodeBase64(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),decodeBase64=e=>{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n},decode=e=>{let t=e;t instanceof Uint8Array&&(t=decoder.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return decodeBase64(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}},JOSEError=class extends Error{constructor(e,t){super(e,t),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}};JOSEError.code="ERR_JOSE_GENERIC";var JWTClaimValidationFailed=class extends JOSEError{constructor(e,t,n="unspecified",r="unspecified"){super(e,{cause:{claim:n,reason:r,payload:t}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=n,this.reason=r,this.payload=t}};JWTClaimValidationFailed.code="ERR_JWT_CLAIM_VALIDATION_FAILED";var JWTExpired=class extends JOSEError{constructor(e,t,n="unspecified",r="unspecified"){super(e,{cause:{claim:n,reason:r,payload:t}}),this.code="ERR_JWT_EXPIRED",this.claim=n,this.reason=r,this.payload=t}};JWTExpired.code="ERR_JWT_EXPIRED";var JOSEAlgNotAllowed=class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}};JOSEAlgNotAllowed.code="ERR_JOSE_ALG_NOT_ALLOWED";var JOSENotSupported=class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}};JOSENotSupported.code="ERR_JOSE_NOT_SUPPORTED";var JWEDecryptionFailed=class extends JOSEError{constructor(e="decryption operation failed",t){super(e,t),this.code="ERR_JWE_DECRYPTION_FAILED"}};JWEDecryptionFailed.code="ERR_JWE_DECRYPTION_FAILED";var JWEInvalid=class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}};JWEInvalid.code="ERR_JWE_INVALID";var JWSInvalid=class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}};JWSInvalid.code="ERR_JWS_INVALID";var JWTInvalid=class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}};JWTInvalid.code="ERR_JWT_INVALID";var JWKInvalid=class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}};JWKInvalid.code="ERR_JWK_INVALID";var JWKSInvalid=class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}};JWKSInvalid.code="ERR_JWKS_INVALID";var JWKSNoMatchingKey=class extends JOSEError{constructor(e="no applicable key found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_NO_MATCHING_KEY"}};JWKSNoMatchingKey.code="ERR_JWKS_NO_MATCHING_KEY";var JWKSMultipleMatchingKeys=class extends JOSEError{constructor(e="multiple matching keys found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}};JWKSMultipleMatchingKeys.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";var JWKSTimeout=class extends JOSEError{constructor(e="request timed out",t){super(e,t),this.code="ERR_JWKS_TIMEOUT"}};JWKSTimeout.code="ERR_JWKS_TIMEOUT";var JWSSignatureVerificationFailed=class extends JOSEError{constructor(e="signature verification failed",t){super(e,t),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}};function unusable(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function isAlgorithm(e,t){return e.name===t}function getHashLength(e){return parseInt(e.name.slice(4),10)}function getNamedCurve(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function checkUsage(e,t){if(t.length&&!t.some((t=>e.usages.includes(t)))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const n=t.pop();e+=`one of ${t.join(", ")}, or ${n}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=`${t[0]}.`;throw new TypeError(e)}}function checkSigCryptoKey(e,t,...n){switch(t){case"HS256":case"HS384":case"HS512":{if(!isAlgorithm(e.algorithm,"HMAC"))throw unusable("HMAC");const n=parseInt(t.slice(2),10);if(getHashLength(e.algorithm.hash)!==n)throw unusable(`SHA-${n}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!isAlgorithm(e.algorithm,"RSASSA-PKCS1-v1_5"))throw unusable("RSASSA-PKCS1-v1_5");const n=parseInt(t.slice(2),10);if(getHashLength(e.algorithm.hash)!==n)throw unusable(`SHA-${n}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!isAlgorithm(e.algorithm,"RSA-PSS"))throw unusable("RSA-PSS");const n=parseInt(t.slice(2),10);if(getHashLength(e.algorithm.hash)!==n)throw unusable(`SHA-${n}`,"algorithm.hash");break}case"EdDSA":if("Ed25519"!==e.algorithm.name&&"Ed448"!==e.algorithm.name)throw unusable("Ed25519 or Ed448");break;case"ES256":case"ES384":case"ES512":{if(!isAlgorithm(e.algorithm,"ECDSA"))throw unusable("ECDSA");const n=getNamedCurve(t);if(e.algorithm.namedCurve!==n)throw unusable(n,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}checkUsage(e,n)}function message(e,t,...n){if((n=n.filter(Boolean)).length>2){const t=n.pop();e+=`one of type ${n.join(", ")}, or ${t}.`}else 2===n.length?e+=`one of type ${n[0]} or ${n[1]}.`:e+=`of type ${n[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}JWSSignatureVerificationFailed.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";var invalid_key_input_default=(e,...t)=>message("Key must be ",e,...t);function withAlg(e,t,...n){return message(`Key for the ${e} algorithm must be `,t,...n)}var is_key_like_default=e=>!!isCryptoKey(e)||"KeyObject"===e?.[Symbol.toStringTag],types=["CryptoKey"],isDisjoint=(...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let n;for(const e of t){const t=Object.keys(e);if(n&&0!==n.size)for(const e of t){if(n.has(e))return!1;n.add(e)}else n=new Set(t)}return!0},is_disjoint_default=isDisjoint;function isObjectLike(e){return"object"==typeof e&&null!==e}function isObject(e){if(!isObjectLike(e)||"[object Object]"!==Object.prototype.toString.call(e))return!1;if(null===Object.getPrototypeOf(e))return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}var check_key_length_default=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:n}=t.algorithm;if("number"!=typeof n||n<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function isJWK(e){return isObject(e)&&"string"==typeof e.kty}function isPrivateJWK(e){return"oct"!==e.kty&&"string"==typeof e.d}function isPublicJWK(e){return"oct"!==e.kty&&void 0===e.d}function isSecretJWK(e){return isJWK(e)&&"oct"===e.kty&&"string"==typeof e.k}function subtleMapping(e){let t,n;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},n=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},n=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},n=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},n=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},n=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},n=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},n=e.d?["deriveBits"]:[];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"EdDSA":t={name:e.crv},n=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},n=e.d?["deriveBits"]:[];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new JOSENotSupported('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:n}}var privCache,pubCache,parse=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:n}=subtleMapping(e),r=[t,e.ext??!1,e.key_ops??n],o={...e};return delete o.alg,delete o.use,webcrypto_default.subtle.importKey("jwk",o,...r)},jwk_to_key_default=parse,exportKeyValue=e=>decode(e),isKeyObject=e=>"KeyObject"===e?.[Symbol.toStringTag],importAndCache=async(e,t,n,r,o=!1)=>{let a=e.get(t);if(a?.[r])return a[r];const s=await jwk_to_key_default({...n,alg:r});return o&&Object.freeze(t),a?a[r]=s:e.set(t,{[r]:s}),s},normalizePublicKey=(e,t)=>{if(isKeyObject(e)){let n=e.export({format:"jwk"});return delete n.d,delete n.dp,delete n.dq,delete n.p,delete n.q,delete n.qi,n.k?exportKeyValue(n.k):(pubCache||(pubCache=new WeakMap),importAndCache(pubCache,e,n,t))}if(isJWK(e)){if(e.k)return decode(e.k);pubCache||(pubCache=new WeakMap);return importAndCache(pubCache,e,e,t,!0)}return e},normalizePrivateKey=(e,t)=>{if(isKeyObject(e)){let n=e.export({format:"jwk"});return n.k?exportKeyValue(n.k):(privCache||(privCache=new WeakMap),importAndCache(privCache,e,n,t))}if(isJWK(e)){if(e.k)return decode(e.k);privCache||(privCache=new WeakMap);return importAndCache(privCache,e,e,t,!0)}return e},normalize_key_default={normalizePublicKey:normalizePublicKey,normalizePrivateKey:normalizePrivateKey};async function importJWK(e,t){if(!isObject(e))throw new TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return decode(e.k);case"RSA":if(void 0!==e.oth)throw new JOSENotSupported('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return jwk_to_key_default({...e,alg:t});default:throw new JOSENotSupported('Unsupported "kty" (Key Type) Parameter value')}}var tag=e=>e?.[Symbol.toStringTag],jwkMatchesOp=(e,t,n)=>{if(void 0!==t.use&&"sig"!==t.use)throw new TypeError("Invalid key for this operation, when present its use must be sig");if(void 0!==t.key_ops&&!0!==t.key_ops.includes?.(n))throw new TypeError(`Invalid key for this operation, when present its key_ops must include ${n}`);if(void 0!==t.alg&&t.alg!==e)throw new TypeError(`Invalid key for this operation, when present its alg must be ${e}`);return!0},symmetricTypeCheck=(e,t,n,r)=>{if(!(t instanceof Uint8Array)){if(r&&isJWK(t)){if(isSecretJWK(t)&&jwkMatchesOp(e,t,n))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!is_key_like_default(t))throw new TypeError(withAlg(e,t,...types,"Uint8Array",r?"JSON Web Key":null));if("secret"!==t.type)throw new TypeError(`${tag(t)} instances for symmetric algorithms must be of type "secret"`)}},asymmetricTypeCheck=(e,t,n,r)=>{if(r&&isJWK(t))switch(n){case"sign":if(isPrivateJWK(t)&&jwkMatchesOp(e,t,n))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"verify":if(isPublicJWK(t)&&jwkMatchesOp(e,t,n))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!is_key_like_default(t))throw new TypeError(withAlg(e,t,...types,r?"JSON Web Key":null));if("secret"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithms must not be of type "secret"`);if("sign"===n&&"public"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm signing must be of type "private"`);if("decrypt"===n&&"public"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm decryption must be of type "private"`);if(t.algorithm&&"verify"===n&&"private"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm verifying must be of type "public"`);if(t.algorithm&&"encrypt"===n&&"private"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm encryption must be of type "public"`)};function checkKeyType(e,t,n,r){t.startsWith("HS")||"dir"===t||t.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(t)?symmetricTypeCheck(t,n,r,e):asymmetricTypeCheck(t,n,r,e)}var check_key_type_default=checkKeyType.bind(void 0,!1),checkKeyTypeWithJwk=checkKeyType.bind(void 0,!0);function validateCrit(e,t,n,r,o){if(void 0!==o.crit&&void 0===r?.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!r||void 0===r.crit)return new Set;if(!Array.isArray(r.crit)||0===r.crit.length||r.crit.some((e=>"string"!=typeof e||0===e.length)))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let a;a=void 0!==n?new Map([...Object.entries(n),...t.entries()]):t;for(const t of r.crit){if(!a.has(t))throw new JOSENotSupported(`Extension Header Parameter "${t}" is not recognized`);if(void 0===o[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(a.get(t)&&void 0===r[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(r.crit)}var validate_crit_default=validateCrit,validateAlgorithms=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some((e=>"string"!=typeof e))))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)},validate_algorithms_default=validateAlgorithms;function subtleDsa(e,t){const n=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:n,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:n,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:n,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:n,name:"ECDSA",namedCurve:t.namedCurve};case"EdDSA":return{name:t.name};default:throw new JOSENotSupported(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}async function getCryptoKey(e,t,n){if("sign"===n&&(t=await normalize_key_default.normalizePrivateKey(t,e)),"verify"===n&&(t=await normalize_key_default.normalizePublicKey(t,e)),isCryptoKey(t))return checkSigCryptoKey(t,e,n),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(invalid_key_input_default(t,...types));return webcrypto_default.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[n])}throw new TypeError(invalid_key_input_default(t,...types,"Uint8Array","JSON Web Key"))}var verify=async(e,t,n,r)=>{const o=await getCryptoKey(e,t,"verify");check_key_length_default(e,o);const a=subtleDsa(e,o.algorithm);try{return await webcrypto_default.subtle.verify(a,o,n,r)}catch{return!1}},verify_default=verify;async function flattenedVerify(e,t,n){if(!isObject(e))throw new JWSInvalid("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new JWSInvalid('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new JWSInvalid("JWS Protected Header incorrect type");if(void 0===e.payload)throw new JWSInvalid("JWS Payload missing");if("string"!=typeof e.signature)throw new JWSInvalid("JWS Signature missing or incorrect type");if(void 0!==e.header&&!isObject(e.header))throw new JWSInvalid("JWS Unprotected Header incorrect type");let r={};if(e.protected)try{const t=decode(e.protected);r=JSON.parse(decoder.decode(t))}catch{throw new JWSInvalid("JWS Protected Header is invalid")}if(!is_disjoint_default(r,e.header))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const o={...r,...e.header};let a=!0;if(validate_crit_default(JWSInvalid,new Map([["b64",!0]]),n?.crit,r,o).has("b64")&&(a=r.b64,"boolean"!=typeof a))throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:s}=o;if("string"!=typeof s||!s)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');const i=n&&validate_algorithms_default("algorithms",n.algorithms);if(i&&!i.has(s))throw new JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter value not allowed');if(a){if("string"!=typeof e.payload)throw new JWSInvalid("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new JWSInvalid("JWS Payload must be a string or an Uint8Array instance");let l=!1;"function"==typeof t?(t=await t(r,e),l=!0,checkKeyTypeWithJwk(s,t,"verify"),isJWK(t)&&(t=await importJWK(t,s))):checkKeyTypeWithJwk(s,t,"verify");const c=concat(encoder.encode(e.protected??""),encoder.encode("."),"string"==typeof e.payload?encoder.encode(e.payload):e.payload);let d;try{d=decode(e.signature)}catch{throw new JWSInvalid("Failed to base64url decode the signature")}if(!await verify_default(s,t,d,c))throw new JWSSignatureVerificationFailed;let u;if(a)try{u=decode(e.payload)}catch{throw new JWSInvalid("Failed to base64url decode the payload")}else u="string"==typeof e.payload?encoder.encode(e.payload):e.payload;const p={payload:u};return void 0!==e.protected&&(p.protectedHeader=r),void 0!==e.header&&(p.unprotectedHeader=e.header),l?{...p,key:t}:p}async function compactVerify(e,t,n){if(e instanceof Uint8Array&&(e=decoder.decode(e)),"string"!=typeof e)throw new JWSInvalid("Compact JWS must be a string or Uint8Array");const{0:r,1:o,2:a,length:s}=e.split(".");if(3!==s)throw new JWSInvalid("Invalid Compact JWS");const i=await flattenedVerify({payload:o,protected:r,signature:a},t,n),l={payload:i.payload,protectedHeader:i.protectedHeader};return"function"==typeof t?{...l,key:i.key}:l}var epoch_default=e=>Math.floor(e.getTime()/1e3),minute=60,hour=60*minute,day=24*hour,week=7*day,year=365.25*day,REGEX=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,secs_default=e=>{const t=REGEX.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const n=parseFloat(t[2]);let r;switch(t[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":r=Math.round(n);break;case"minute":case"minutes":case"min":case"mins":case"m":r=Math.round(n*minute);break;case"hour":case"hours":case"hr":case"hrs":case"h":r=Math.round(n*hour);break;case"day":case"days":case"d":r=Math.round(n*day);break;case"week":case"weeks":case"w":r=Math.round(n*week);break;default:r=Math.round(n*year)}return"-"===t[1]||"ago"===t[4]?-r:r},normalizeTyp=e=>e.toLowerCase().replace(/^application\//,""),checkAudiencePresence=(e,t)=>"string"==typeof e?t.includes(e):!!Array.isArray(e)&&t.some(Set.prototype.has.bind(new Set(e))),jwt_claims_set_default=(e,t,n={})=>{let r;try{r=JSON.parse(decoder.decode(t))}catch{}if(!isObject(r))throw new JWTInvalid("JWT Claims Set must be a top-level JSON object");const{typ:o}=n;if(o&&("string"!=typeof e.typ||normalizeTyp(e.typ)!==normalizeTyp(o)))throw new JWTClaimValidationFailed('unexpected "typ" JWT header value',r,"typ","check_failed");const{requiredClaims:a=[],issuer:s,subject:i,audience:l,maxTokenAge:c}=n,d=[...a];void 0!==c&&d.push("iat"),void 0!==l&&d.push("aud"),void 0!==i&&d.push("sub"),void 0!==s&&d.push("iss");for(const e of new Set(d.reverse()))if(!(e in r))throw new JWTClaimValidationFailed(`missing required "${e}" claim`,r,e,"missing");if(s&&!(Array.isArray(s)?s:[s]).includes(r.iss))throw new JWTClaimValidationFailed('unexpected "iss" claim value',r,"iss","check_failed");if(i&&r.sub!==i)throw new JWTClaimValidationFailed('unexpected "sub" claim value',r,"sub","check_failed");if(l&&!checkAudiencePresence(r.aud,"string"==typeof l?[l]:l))throw new JWTClaimValidationFailed('unexpected "aud" claim value',r,"aud","check_failed");let u;switch(typeof n.clockTolerance){case"string":u=secs_default(n.clockTolerance);break;case"number":u=n.clockTolerance;break;case"undefined":u=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:p}=n,h=epoch_default(p||new Date);if((void 0!==r.iat||c)&&"number"!=typeof r.iat)throw new JWTClaimValidationFailed('"iat" claim must be a number',r,"iat","invalid");if(void 0!==r.nbf){if("number"!=typeof r.nbf)throw new JWTClaimValidationFailed('"nbf" claim must be a number',r,"nbf","invalid");if(r.nbf>h+u)throw new JWTClaimValidationFailed('"nbf" claim timestamp check failed',r,"nbf","check_failed")}if(void 0!==r.exp){if("number"!=typeof r.exp)throw new JWTClaimValidationFailed('"exp" claim must be a number',r,"exp","invalid");if(r.exp<=h-u)throw new JWTExpired('"exp" claim timestamp check failed',r,"exp","check_failed")}if(c){const e=h-r.iat;if(e-u>("number"==typeof c?c:secs_default(c)))throw new JWTExpired('"iat" claim timestamp check failed (too far in the past)',r,"iat","check_failed");if(e<0-u)throw new JWTClaimValidationFailed('"iat" claim timestamp check failed (it should be in the past)',r,"iat","check_failed")}return r};async function jwtVerify(e,t,n){const r=await compactVerify(e,t,n);if(r.protectedHeader.crit?.includes("b64")&&!1===r.protectedHeader.b64)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");const o={payload:jwt_claims_set_default(r.protectedHeader,r.payload,n),protectedHeader:r.protectedHeader};return"function"==typeof t?{...o,key:r.key}:o}var sign=async(e,t,n)=>{const r=await getCryptoKey(e,t,"sign");check_key_length_default(e,r);const o=await webcrypto_default.subtle.sign(subtleDsa(e,r.algorithm),r,n);return new Uint8Array(o)},sign_default=sign,FlattenedSign=class{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){if(!this._protectedHeader&&!this._unprotectedHeader)throw new JWSInvalid("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!is_disjoint_default(this._protectedHeader,this._unprotectedHeader))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const n={...this._protectedHeader,...this._unprotectedHeader};let r=!0;if(validate_crit_default(JWSInvalid,new Map([["b64",!0]]),t?.crit,this._protectedHeader,n).has("b64")&&(r=this._protectedHeader.b64,"boolean"!=typeof r))throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:o}=n;if("string"!=typeof o||!o)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');checkKeyTypeWithJwk(o,e,"sign");let a,s=this._payload;r&&(s=encoder.encode(encode(s))),a=this._protectedHeader?encoder.encode(encode(JSON.stringify(this._protectedHeader))):encoder.encode("");const i=concat(a,encoder.encode("."),s),l=await sign_default(o,e,i),c={signature:encode(l),payload:""};return r&&(c.payload=decoder.decode(s)),this._unprotectedHeader&&(c.header=this._unprotectedHeader),this._protectedHeader&&(c.protected=decoder.decode(a)),c}},CompactSign=class{constructor(e){this._flattened=new FlattenedSign(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){const n=await this._flattened.sign(e,t);if(void 0===n.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${n.protected}.${n.payload}.${n.signature}`}};function validateInput(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}var hashPassword,ProduceJWT=class{constructor(e={}){if(!isObject(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return"number"==typeof e?this._payload={...this._payload,nbf:validateInput("setNotBefore",e)}:e instanceof Date?this._payload={...this._payload,nbf:validateInput("setNotBefore",epoch_default(e))}:this._payload={...this._payload,nbf:epoch_default(new Date)+secs_default(e)},this}setExpirationTime(e){return"number"==typeof e?this._payload={...this._payload,exp:validateInput("setExpirationTime",e)}:e instanceof Date?this._payload={...this._payload,exp:validateInput("setExpirationTime",epoch_default(e))}:this._payload={...this._payload,exp:epoch_default(new Date)+secs_default(e)},this}setIssuedAt(e){return void 0===e?this._payload={...this._payload,iat:epoch_default(new Date)}:e instanceof Date?this._payload={...this._payload,iat:validateInput("setIssuedAt",epoch_default(e))}:this._payload="string"==typeof e?{...this._payload,iat:validateInput("setIssuedAt",epoch_default(new Date)+secs_default(e))}:{...this._payload,iat:validateInput("setIssuedAt",e)},this}},SignJWT=class extends ProduceJWT{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){const n=new CompactSign(encoder.encode(JSON.stringify(this._payload)));if(n.setProtectedHeader(this._protectedHeader),Array.isArray(this._protectedHeader?.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");return n.sign(e,t)}},userID="89b3cbba-e6ac-485a-9481-976a0415eab9",trojanPassword="bpb-trojan",proxyIPs=["bpb.yousef.isegaro.com"],defaultHttpPorts=["80","8080","2052","2082","2086","2095","8880"],defaultHttpsPorts=["443","8443","2053","2083","2087","2096"],proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],dohURL="https://cloudflare-dns.com/dns-query",panelVersion="2.7",worker_default={async fetch(e,t){try{if(userID=t.UUID||userID,proxyIP=t.PROXYIP||proxyIP,dohURL=t.DNS_RESOLVER_URL||dohURL,trojanPassword=t.TROJAN_PASS||trojanPassword,hashPassword=import_js_sha256.default.sha224(trojanPassword),!isValidUUID(userID))throw new Error(`Invalid UUID: ${userID}`);const n=e.headers.get("Upgrade"),r=new URL(e.url);if(n&&"websocket"===n)return r.pathname.startsWith("/tr")?await trojanOverWSHandler(e):await vlessOverWSHandler(e);{const n=new URLSearchParams(r.search),o=e.headers.get("Host"),a=n.get("app"),{kvNotFound:s,proxySettings:i,warpConfigs:l}=await getDataset(t);if(s){const e=renderErrorPage("KV Dataset is not properly set!",null,!0);return new Response(e,{status:200,headers:{"Content-Type":"text/html"}})}switch(r.pathname){case"/cf":return new Response(JSON.stringify(e.cf,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8"}});case"/update-warp":if(!await Authenticate(e,t))return new Response("Unauthorized",{status:401});if("POST"!==e.method)return new Response("Unsupported request",{status:405});try{const{error:e}=await fetchWgConfig(t,i);return e?new Response(e,{status:400}):new Response("Warp configs updated successfully",{status:200})}catch(e){return console.log(e),new Response(`An error occurred while updating Warp configs! - ${e}`,{status:500})}case`/sub/${userID}`:if("sfa"===a){const e=await getSingBoxCustomConfig(t,i,o,a,!1);return new Response(JSON.stringify(e,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}if("clash"===a){const e=await getClashNormalConfig(t,i,o);return new Response(JSON.stringify(e,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}if("xray"===a){const e=await getXrayCustomConfigs(t,i,o,!1);return new Response(JSON.stringify(e,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}const n=await getNormalConfigs(i,o,a);return new Response(n,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}});case`/fragsub/${userID}`:let s="hiddify"===a?await getSingBoxCustomConfig(t,i,o,a,!0):await getXrayCustomConfigs(t,i,o,!0);return new Response(JSON.stringify(s,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}});case`/warpsub/${userID}`:if("clash"===a){const e=await getClashWarpConfig(i,l);return new Response(JSON.stringify(e,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}if("singbox"===a||"hiddify"===a){const e=await getSingBoxWarpConfig(i,l,a);return new Response(JSON.stringify(e,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}const c=await getXrayWarpConfigs(i,l,a);return new Response(JSON.stringify(c,null,4),{status:200,headers:{"Content-Type":"application/json;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}});case"/panel":const d=await t.bpb.get("pwd"),u=await Authenticate(e,t);if("POST"===e.method){if(!u)return new Response("Unauthorized or expired session!",{status:401});const n=await e.formData();return"true"===n.get("resetSettings")?await updateDataset(t,null,!0):await updateDataset(t,n),new Response("Success",{status:200})}if(d&&!u)return Response.redirect(`${r.origin}/login`,302);const p=renderHomePage(i,o,d?.length>=8);return new Response(p,{status:200,headers:{"Content-Type":"text/html","Access-Control-Allow-Origin":r.origin,"Access-Control-Allow-Methods":"GET, POST","Access-Control-Allow-Headers":"Content-Type, Authorization","X-Content-Type-Options":"nosniff","X-Frame-Options":"DENY","Referrer-Policy":"strict-origin-when-cross-origin"}});case"/login":if("object"!=typeof t.bpb){const e=renderErrorPage("KV Dataset is not properly set!",null,!0);return new Response(e,{status:200,headers:{"Content-Type":"text/html"}})}if(await Authenticate(e,t))return Response.redirect(`${r.origin}/panel`,302);let h=await t.bpb.get("secretKey");if(h||(h=generateSecretKey(),await t.bpb.put("secretKey",h)),"POST"===e.method){const n=await e.text();if(n===await t.bpb.get("pwd")){const e=`jwtToken=${await generateJWTToken(h)}; HttpOnly; Secure; Max-Age=604800; Path=/; SameSite=Strict`;return new Response("Success",{status:200,headers:{"Set-Cookie":e,"Content-Type":"text/plain"}})}return new Response("Method Not Allowed",{status:405})}const f=renderLoginPage();return new Response(f,{status:200,headers:{"Content-Type":"text/html","Access-Control-Allow-Origin":r.origin,"Access-Control-Allow-Methods":"GET, POST","Access-Control-Allow-Headers":"Content-Type, Authorization","X-Content-Type-Options":"nosniff","X-Frame-Options":"DENY","Referrer-Policy":"strict-origin-when-cross-origin"}});case"/logout":return new Response("Success",{status:200,headers:{"Set-Cookie":"jwtToken=; Secure; SameSite=None; Expires=Thu, 01 Jan 1970 00:00:00 GMT","Content-Type":"text/plain"}});case"/panel/password":const y=await t.bpb.get("pwd");let m=await Authenticate(e,t);if(y&&!m)return new Response("Unauthorized!",{status:401});const b=await e.text();return b===y?new Response("Please enter a new Password!",{status:400}):(await t.bpb.put("pwd",b),new Response("Success",{status:200,headers:{"Set-Cookie":"jwtToken=; Path=/; Secure; SameSite=None; Expires=Thu, 01 Jan 1970 00:00:00 GMT","Content-Type":"text/plain"}}));default:return r.hostname="www.speedtest.net",r.protocol="https:",e=new Request(r,e),await fetch(e)}}}catch(e){const t=renderErrorPage("Something went wrong!",e,!1);return new Response(t,{status:200,headers:{"Content-Type":"text/html"}})}}};async function vlessOverWSHandler(e){const t=new WebSocketPair,[n,r]=Object.values(t);r.accept();let o="",a="";const s=(e,t)=>{console.log(`[${o}:${a}] ${e}`,t||"")},i=e.headers.get("sec-websocket-protocol")||"",l=makeReadableWebSocketStream(r,i,s);let c={value:null},d=null,u=!1;return l.pipeTo(new WritableStream({async write(t,n){if(u&&d)return d(t);if(c.value){const e=c.value.writable.getWriter();return await e.write(t),void e.releaseLock()}const{hasError:i,message:l,portRemote:p=443,addressRemote:h="",rawDataIndex:f,vlessVersion:y=new Uint8Array([0,0]),isUDP:m}=await processVlessHeader(t,userID);if(o=h,a=`${p}--${Math.random()} ${m?"udp ":"tcp "} `,i)throw new Error(l);if(m){if(53!==p)throw new Error("UDP proxy only enable for DNS which is port 53");u=!0}const b=new Uint8Array([y[0],0]),g=t.slice(f);if(u){const{write:e}=await handleUDPOutBound(r,b,s);return d=e,void d(g)}handleTCPOutBound(e,c,h,p,g,r,b,s)},close(){s("readableWebSocketStream is close")},abort(e){s("readableWebSocketStream is abort",JSON.stringify(e))}})).catch((e=>{s("readableWebSocketStream pipeTo error",e)})),new Response(null,{status:101,webSocket:n})}async function checkUuidInApiResponse(e){try{const t=await getApiResponse();if(!t)return!1;return t.users.some((t=>t.uuid===e))}catch(e){return console.error("Error:",e),!1}}async function trojanOverWSHandler(e){const t=new WebSocketPair,[n,r]=Object.values(t);r.accept();let o="",a="";const s=(e,t)=>{console.log(`[${o}:${a}] ${e}`,t||"")},i=e.headers.get("sec-websocket-protocol")||"",l=makeReadableWebSocketStream(r,i,s);let c={value:null};return l.pipeTo(new WritableStream({async write(t,n){if(c.value){const e=c.value.writable.getWriter();return await e.write(t),void e.releaseLock()}const{hasError:i,message:l,portRemote:d=443,addressRemote:u="",rawClientData:p}=await parseTrojanHeader(t);if(o=u,a=`${d}--${Math.random()} tcp`,i)throw new Error(l);handleTCPOutBound(e,c,u,d,p,r,!1,s)},close(){s("readableWebSocketStream is closed")},abort(e){s("readableWebSocketStream is aborted",JSON.stringify(e))}})).catch((e=>{s("readableWebSocketStream pipeTo error",e)})),new Response(null,{status:101,webSocket:n})}async function parseTrojanHeader(e){if(e.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(e.slice(56,57))[0]||10!==new Uint8Array(e.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(e.slice(0,56))!==hashPassword)return{hasError:!0,message:"invalid password"};const t=e.slice(58);if(t.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};const n=new DataView(t);if(1!==n.getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};const r=n.getUint8(1);let o=0,a=2,s="";switch(r){case 1:o=4,s=new Uint8Array(t.slice(a,a+o)).join(".");break;case 3:o=new Uint8Array(t.slice(a,a+1))[0],a+=1,s=(new TextDecoder).decode(t.slice(a,a+o));break;case 4:o=16;const e=new DataView(t.slice(a,a+o)),n=[];for(let t=0;t<8;t++)n.push(e.getUint16(2*t).toString(16));s=n.join(":");break;default:return{hasError:!0,message:`invalid addressType is ${r}`}}if(!s)return{hasError:!0,message:`address is empty, addressType is ${r}`};const i=a+o,l=t.slice(i,i+2);return{hasError:!1,addressRemote:s,portRemote:new DataView(l).getUint16(0),rawClientData:t.slice(i+4)}}async function handleTCPOutBound(e,t,n,r,o,a,s,i){async function l(e,n){/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)&&(e=`${atob("d3d3Lg==")}${e}${atob("LnNzbGlwLmlv")}`);const r=connect({hostname:e,port:n});t.value=r,i(`connected to ${e}:${n}`);const a=r.writable.getWriter();return await a.write(o),a.releaseLock(),r}async function c(){const{pathname:t}=new URL(e.url);let o=t.split("/")[2];o=o?atob(o):void 0;const c=await l(o||proxyIP||n,r);c.closed.catch((e=>{console.log("retry tcpSocket closed error",e)})).finally((()=>{safeCloseWebSocket(a)})),s?vlessRemoteSocketToWS(c,a,s,null,i):trojanRemoteSocketToWS(c,a,null,i)}const d=await l(n,r);s?vlessRemoteSocketToWS(d,a,s,c,i):trojanRemoteSocketToWS(d,a,c,i)}function makeReadableWebSocketStream(e,t,n){let r=!1;return new ReadableStream({start(o){e.addEventListener("message",(e=>{if(r)return;const t=e.data;o.enqueue(t)})),e.addEventListener("close",(()=>{safeCloseWebSocket(e),r||o.close()})),e.addEventListener("error",(e=>{n("webSocketServer has error"),o.error(e)}));const{earlyData:a,error:s}=base64ToArrayBuffer(t);s?o.error(s):a&&o.enqueue(a)},pull(e){},cancel(t){r||(n(`ReadableStream was canceled, due to ${t}`),r=!0,safeCloseWebSocket(e))}})}async function processVlessHeader(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};const n=new Uint8Array(e.slice(0,1));let r=!1,o=!1;const a=stringify(new Uint8Array(e.slice(1,17))),s=t.includes(",")?t.split(","):[t],i=await checkUuidInApiResponse(a);if(r=s.some((e=>i||a===e.trim())),console.log(`checkUuidInApi: ${await checkUuidInApiResponse(a)}, userID: ${a}`),!r)return{hasError:!0,message:"invalid user"};const l=new Uint8Array(e.slice(17,18))[0],c=new Uint8Array(e.slice(18+l,18+l+1))[0];if(1===c);else{if(2!==c)return{hasError:!0,message:`command ${c} is not support, command 01-tcp,02-udp,03-mux`};o=!0}const d=18+l+1,u=e.slice(d,d+2),p=new DataView(u).getUint16(0);let h=d+2;const f=new Uint8Array(e.slice(h,h+1))[0];let y=0,m=h+1,b="";switch(f){case 1:y=4,b=new Uint8Array(e.slice(m,m+y)).join(".");break;case 2:y=new Uint8Array(e.slice(m,m+1))[0],m+=1,b=(new TextDecoder).decode(e.slice(m,m+y));break;case 3:y=16;const t=new DataView(e.slice(m,m+y)),n=[];for(let e=0;e<8;e++)n.push(t.getUint16(2*e).toString(16));b=n.join(":");break;default:return{hasError:!0,message:`invild  addressType is ${f}`}}return b?{hasError:!1,addressRemote:b,addressType:f,portRemote:p,rawDataIndex:m+y,vlessVersion:n,isUDP:o}:{hasError:!0,message:`addressValue is empty, addressType is ${f}`}}async function vlessRemoteSocketToWS(e,t,n,r,o){let a=n,s=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,n){s=!0,t.readyState!==WS_READY_STATE_OPEN&&n.error("webSocket.readyState is not open, maybe close"),a?(t.send(await new Blob([a,e]).arrayBuffer()),a=null):t.send(e)},close(){o(`remoteConnection!.readable is close with hasIncomingData is ${s}`)},abort(e){console.error("remoteConnection!.readable abort",e)}})).catch((e=>{console.error("vlessRemoteSocketToWS has exception ",e.stack||e),safeCloseWebSocket(t)})),!1===s&&r&&(o("retry"),r())}async function trojanRemoteSocketToWS(e,t,n,r){let o=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,n){o=!0,t.readyState!==WS_READY_STATE_OPEN&&n.error("webSocket connection is not open"),t.send(e)},close(){r(`remoteSocket.readable is closed, hasIncomingData: ${o}`)},abort(e){console.error("remoteSocket.readable abort",e)}})).catch((e=>{console.error("trojanRemoteSocketToWS error:",e.stack||e),safeCloseWebSocket(t)})),!1===o&&n&&(r("retry"),n())}function base64ToArrayBuffer(e){if(!e)return{earlyData:null,error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");const t=atob(e);return{earlyData:Uint8Array.from(t,(e=>e.charCodeAt(0))).buffer,error:null}}catch(e){return{earlyData:null,error:e}}}function isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}var WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}var byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,t=0){return(byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]).toLowerCase()}function stringify(e,t=0){const n=unsafeStringify(e,t);if(!isValidUUID(n))throw TypeError("Stringified UUID is invalid");return n}async function handleUDPOutBound(e,t,n){let r=!1;const o=new TransformStream({start(e){},transform(e,t){for(let n=0;n<e.byteLength;){const r=e.slice(n,n+2),o=new DataView(r).getUint16(0),a=new Uint8Array(e.slice(n+2,n+2+o));n=n+2+o,t.enqueue(a)}},flush(e){}});o.readable.pipeTo(new WritableStream({async write(o){const a=await fetch(dohURL,{method:"POST",headers:{"content-type":"application/dns-message"},body:o}),s=await a.arrayBuffer(),i=s.byteLength,l=new Uint8Array([i>>8&255,255&i]);e.readyState===WS_READY_STATE_OPEN&&(n(`doh success and dns message length is ${i}`),r?e.send(await new Blob([l,s]).arrayBuffer()):(e.send(await new Blob([t,l,s]).arrayBuffer()),r=!0))}})).catch((e=>{n("dns udp has error"+e)}));const a=o.writable.getWriter();return{write(e){a.write(e)}}}var generateKeyPair=()=>{const e=e=>btoa(String.fromCharCode.apply(null,e));let t=import_tweetnacl.default.randomBytes(32);t[0]&=248,t[31]&=127,t[31]|=64;return{publicKey:e(import_tweetnacl.default.scalarMult.base(t)),privateKey:e(t)}};function generateRemark(e,t,n,r,o,a){let s;const i=a?` ${a}`:"";return s=r.includes(n)?"Clean IP":isDomain(n)?"Domain":isIPv4(n)?"IPv4":isIPv6(n)?"IPv6":"",` ${e} - ${o}${i} - ${s} : ${t}`}function isDomain(e){return/^(?!\-)(?:[A-Za-z0-9\-]{1,63}\.?)+[A-Za-z]{2,}$/.test(e)}function isIPv4(e){return/^(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}function isIPv6(e){return/^\[(?:(?:[a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,7}:|::(?:[a-fA-F0-9]{1,4}:){0,7}|(?:[a-fA-F0-9]{1,4}:){1,6}:[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,5}(?::[a-fA-F0-9]{1,4}){1,2}|(?:[a-fA-F0-9]{1,4}:){1,4}(?::[a-fA-F0-9]{1,4}){1,3}|(?:[a-fA-F0-9]{1,4}:){1,3}(?::[a-fA-F0-9]{1,4}){1,4}|(?:[a-fA-F0-9]{1,4}:){1,2}(?::[a-fA-F0-9]{1,4}){1,5}|[a-fA-F0-9]{1,4}:(?::[a-fA-F0-9]{1,4}){1,6})\]$/.test(e)}function base64ToDecimal(e){const t=atob(e);return Array.from(t).map((e=>e.charCodeAt(0).toString(16).padStart(2,"0"))).join("").match(/.{2}/g).map((e=>parseInt(e,16)))}async function getDataset(e){let t,n;if("object"!=typeof e.bpb)return{kvNotFound:!0,proxySettings:null,warpConfigs:null};try{t=await e.bpb.get("proxySettings",{type:"json"}),n=await e.bpb.get("warpConfigs",{type:"json"})}catch(e){throw console.log(e),new Error(`An error occurred while getting KV - ${e}`)}if(!t){t=await updateDataset(e);const{error:r,configs:o}=await fetchWgConfig(e,t);if(r)throw new Error(`An error occurred while getting Warp configs - ${r}`);n=o}return panelVersion!==t.panelVersion&&(t=await updateDataset(e)),{kvNotFound:!1,proxySettings:t,warpConfigs:n}}async function updateDataset(e,t,n){let r;if(n)await e.bpb.delete("warpConfigs");else try{r=await e.bpb.get("proxySettings",{type:"json"})}catch(e){throw console.log(e),new Error(`An error occurred while getting current KV settings - ${e}`)}const o=e=>{const n=t?.get(e);return void 0===n?null:"true"===n||"false"!==n&&n},a=o("remoteDNS")??r?.remoteDNS??"https://8.8.8.8/dns-query",s=new URL(a).hostname;let i;if(isDomain(s))try{const e=await resolveDNS(s);i={server:s,staticIPs:[...e.ipv4,...e.ipv6]}}catch(e){throw console.log(e),new Error(`An error occurred while resolving remote DNS server, please try agian! - ${e}`)}const l={remoteDNS:a,resolvedRemoteDNS:i??{},localDNS:o("localDNS")??r?.localDNS??"8.8.8.8",vlessTrojanFakeDNS:o("vlessTrojanFakeDNS")??r?.vlessTrojanFakeDNS??!1,proxyIP:o("proxyIP")?.trim()??r?.proxyIP??"",outProxy:o("outProxy")??r?.outProxy??"",outProxyParams:extractChainProxyParams(o("outProxy"))??r?.outProxyParams??"",cleanIPs:o("cleanIPs")?.replaceAll(" ","")??r?.cleanIPs??"",enableIPv6:o("enableIPv6")??r?.enableIPv6??!0,customCdnAddrs:o("customCdnAddrs")?.replaceAll(" ","")??r?.customCdnAddrs??"",customCdnHost:o("customCdnHost")?.trim()??r?.customCdnHost??"",customCdnSni:o("customCdnSni")?.trim()??r?.customCdnSni??"",bestVLESSTrojanInterval:o("bestVLESSTrojanInterval")??r?.bestVLESSTrojanInterval??"30",vlessConfigs:o("vlessConfigs")??r?.vlessConfigs??!0,trojanConfigs:o("trojanConfigs")??r?.trojanConfigs??!1,ports:o("ports")?.split(",")??r?.ports??["443"],lengthMin:o("fragmentLengthMin")??r?.lengthMin??"100",lengthMax:o("fragmentLengthMax")??r?.lengthMax??"200",intervalMin:o("fragmentIntervalMin")??r?.intervalMin??"1",intervalMax:o("fragmentIntervalMax")??r?.intervalMax??"1",fragmentPackets:o("fragmentPackets")??r?.fragmentPackets??"tlshello",bypassLAN:o("bypass-lan")??r?.bypassLAN??!1,bypassIran:o("bypass-iran")??r?.bypassIran??!1,bypassChina:o("bypass-china")??r?.bypassChina??!1,bypassRussia:o("bypass-russia")??r?.bypassRussia??!1,blockAds:o("block-ads")??r?.blockAds??!1,blockPorn:o("block-porn")??r?.blockPorn??!1,blockUDP443:o("block-udp-443")??r?.blockUDP443??!1,warpEndpoints:o("warpEndpoints")?.replaceAll(" ","")??r?.warpEndpoints??"engage.cloudflareclient.com:2408",warpFakeDNS:o("warpFakeDNS")??r?.warpFakeDNS??!1,warpPlusLicense:o("warpPlusLicense")??r?.warpPlusLicense??"",bestWarpInterval:o("bestWarpInterval")??r?.bestWarpInterval??"30",hiddifyNoiseMode:o("hiddifyNoiseMode")??r?.hiddifyNoiseMode??"m4",nikaNGNoiseMode:o("nikaNGNoiseMode")??r?.nikaNGNoiseMode??"quic",noiseCountMin:o("noiseCountMin")??r?.noiseCountMin??"10",noiseCountMax:o("noiseCountMax")??r?.noiseCountMax??"15",noiseSizeMin:o("noiseSizeMin")??r?.noiseSizeMin??"5",noiseSizeMax:o("noiseSizeMax")??r?.noiseSizeMax??"10",noiseDelayMin:o("noiseDelayMin")??r?.noiseDelayMin??"1",noiseDelayMax:o("noiseDelayMax")??r?.noiseDelayMax??"1",panelVersion:panelVersion};try{await e.bpb.put("proxySettings",JSON.stringify(l))}catch(e){throw console.log(e),new Error(`An error occurred while updating KV - ${e}`)}return l}function randomUpperCase(e){let t="";for(let n=0;n<e.length;n++)t+=Math.random()<.5?e[n].toUpperCase():e[n];return t}function getRandomPath(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let r=0;r<e;r++)t+=n.charAt(Math.floor(62*Math.random()));return t}async function resolveDNS(e){const t=`${dohURL}?name=${encodeURIComponent(e)}&type=A`,n=`${dohURL}?name=${encodeURIComponent(e)}&type=AAAA`;try{const[e,r]=await Promise.all([fetch(t,{headers:{accept:"application/dns-json"}}),fetch(n,{headers:{accept:"application/dns-json"}})]),o=await e.json(),a=await r.json(),s=o.Answer?o.Answer.map((e=>e.data)):[];return{ipv4:s,ipv6:a.Answer?a.Answer.map((e=>e.data)):[]}}catch(e){throw console.error("Error resolving DNS:",e),new Error(`An error occurred while resolving DNS - ${e}`)}}async function getConfigAddresses(e,t,n){const r=await resolveDNS(e),o=n?r.ipv6.map((e=>`[${e}]`)):[];return[e,"www.speedtest.net",...r.ipv4,...o,...t?t.split(","):[]]}async function generateJWTToken(e){const t=(new TextEncoder).encode(e);return await new SignJWT({userID:userID}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("24h").sign(t)}function generateSecretKey(){const e=import_tweetnacl.default.randomBytes(32);return Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("")}async function Authenticate(e,t){try{const n=await t.bpb.get("secretKey"),r=(new TextEncoder).encode(n),o=e.headers.get("Cookie")?.match(/(^|;\s*)jwtToken=([^;]*)/),a=o?o[2]:null;if(!a)return console.log("Unauthorized: Token not available!"),!1;const{payload:s}=await jwtVerify(a,r);return console.log(`Successfully logined, User ID: ${s.userID}`),!0}catch(e){return console.log(e),!1}}function renderHomePage(e,t,n){const{remoteDNS:r,localDNS:o,vlessTrojanFakeDNS:a,proxyIP:s,outProxy:i,cleanIPs:l,enableIPv6:c,customCdnAddrs:d,customCdnHost:u,customCdnSni:p,bestVLESSTrojanInterval:h,vlessConfigs:f,trojanConfigs:y,ports:m,lengthMin:b,lengthMax:g,intervalMin:v,intervalMax:w,fragmentPackets:S,warpEndpoints:x,warpFakeDNS:k,warpPlusLicense:_,bestWarpInterval:C,hiddifyNoiseMode:P,nikaNGNoiseMode:E,noiseCountMin:A,noiseCountMax:T,noiseSizeMin:I,noiseSizeMax:D,noiseDelayMin:R,noiseDelayMax:N,bypassLAN:$,bypassIran:W,bypassChina:M,bypassRussia:O,blockAds:B,blockPorn:J,blockUDP443:U}=e,L=!!_;let F=(f?1:0)+(y?1:0),H="",j="";[...t.includes("workers.dev")?defaultHttpPorts:[],...defaultHttpsPorts].forEach((e=>{let t=`port-${e}`;let n=`\n            <div class="routing" style="grid-template-columns: 1fr 2fr; margin-right: 10px;">\n                <input type="checkbox" id=${t} name=${e} onchange="handlePortChange(event)" value="true" ${m.includes(e)?"checked":""}>\n                <label style="margin-bottom: 3px;" for=${t}>${e}</label>\n            </div>`;defaultHttpsPorts.includes(e)?j+=n:H+=n}));return`\n    <!DOCTYPE html>\n    <html lang="en">\n    <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <title>BPB Panel ${panelVersion}</title>\n        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">\n        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />\n        <title>Collapsible Sections</title>\n        <style>\n            :root {\n                --color: black;\n                --primary-color: #09639f;\n                --secondary-color: #3498db;\n                --header-color: #09639f; \n                --background-color: #fff;\n                --form-background-color: #f9f9f9;\n                --table-active-color: #f2f2f2;\n                --hr-text-color: #3b3b3b;\n                --lable-text-color: #333;\n                --border-color: #ddd;\n                --button-color: #09639f;\n                --input-background-color: white;\n                --header-shadow: 2px 2px 4px rgba(0, 0, 0, 0.25);\n            }\n            body { font-family: system-ui; background-color: var(--background-color); color: var(--color) }\n            body.dark-mode {\n                --color: white;\n                --primary-color: #09639F;\n                --secondary-color: #3498DB;\n                --header-color: #3498DB; \n                --background-color: #121212;\n                --form-background-color: #121212;\n                --table-active-color: #252525;\n                --hr-text-color: #D5D5D5;\n                --lable-text-color: #DFDFDF;\n                --border-color: #353535;\n                --button-color: #3498DB;\n                --input-background-color: #252525;\n                --header-shadow: 2px 2px 4px rgba(255, 255, 255, 0.25);\n            }\n            .material-symbols-outlined {\n                margin-left: 5px;\n                font-variation-settings:\n                'FILL' 0,\n                'wght' 400,\n                'GRAD' 0,\n                'opsz' 24\n            }\n            details { border-bottom: 1px solid var(--border-color); }\n            summary {\n                font-weight: bold;\n                cursor: pointer;\n                text-align: center;\n                text-wrap: nowrap;\n            }\n            summary::marker { font-size: 1.5rem; color: var(--secondary-color); }\n            summary h2 { display: inline-flex; }\n            h1 { font-size: 2.5em; text-align: center; color: var(--header-color); text-shadow: var(--header-shadow); }\n            h2 { margin: 30px 0; text-align: center; color: var(--hr-text-color); }\n            hr { border: 1px solid var(--border-color); margin: 20px 0; }\n            .footer {\n                display: flex;\n                font-weight: 600;\n                margin: 10px auto 0 auto;\n                justify-content: center;\n                align-items: center;\n            }\n            .footer button {margin: 0 20px; background: #212121; max-width: fit-content;}\n            .footer button:hover, .footer button:focus { background: #3b3b3b;}\n            .form-control a, a.link { text-decoration: none; }\n            .form-control {\n                margin-bottom: 20px;\n                font-family: Arial, sans-serif;\n                display: flex;\n                flex-direction: column;\n            }\n            .form-control button {\n                background-color: var(--form-background-color);\n                font-size: 1.1rem;\n                font-weight: 600;\n                color: var(--button-color);\n                border-color: var(--primary-color);\n                border: 1px solid;\n            }\n            #apply {display: block; margin-top: 20px;}\n            input.button {font-weight: 600; padding: 15px 0; font-size: 1.1rem;}\n            label {\n                display: block;\n                margin-bottom: 5px;\n                font-size: 110%;\n                font-weight: 600;\n                color: var(--lable-text-color);\n            }\n            input[type="text"],\n            input[type="number"],\n            input[type="url"],\n            textarea,\n            select {\n                width: 100%;\n                text-align: center;\n                padding: 10px;\n                border: 1px solid var(--border-color);\n                border-radius: 5px;\n                font-size: 16px;\n                color: var(--lable-text-color);\n                background-color: var(--input-background-color);\n                box-sizing: border-box;\n                transition: border-color 0.3s ease;\n            }\t\n            input[type="text"]:focus,\n            input[type="number"]:focus,\n            input[type="url"]:focus,\n            textarea:focus,\n            select:focus { border-color: var(--secondary-color); outline: none; }\n            .button,\n            table button {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 100%;\n                white-space: nowrap;\n                padding: 10px 15px;\n                font-size: 16px;\n                font-weight: 600;\n                letter-spacing: 1px;\n                border: none;\n                border-radius: 5px;\n                color: white;\n                background-color: var(--primary-color);\n                cursor: pointer;\n                outline: none;\n                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);\n                transition: all 0.3s ease;\n            }\n            input[type="checkbox"] { \n                background-color: var(--input-background-color);\n                style="margin: 0; \n                grid-column: 2;"\n            }\n            table button { margin: auto; width: auto; }\n            .button.disabled {\n                background-color: #ccc;\n                cursor: not-allowed;\n                box-shadow: none;\n                pointer-events: none;\n            }\n            .button:hover,\n            table button:hover,\n            table button:focus {\n                background-color: #2980b9;\n                box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);\n                transform: translateY(-2px);\n            }\n            button.button:hover { color: white; }\n            .button:active,\n            table button:active { transform: translateY(1px); box-shadow: 0 3px 7px rgba(0, 0, 0, 0.3); }\n            .form-container {\n                max-width: 90%;\n                margin: 0 auto;\n                padding: 20px;\n                background: var(--form-background-color);\n                border: 1px solid var(--border-color);\n                border-radius: 10px;\n                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n                margin-bottom: 100px;\n            }\n            .table-container { margin-top: 20px; overflow-x: auto; }\n            table { \n                width: 100%;\n                border: 1px solid var(--border-color);\n                border-collapse: separate;\n                border-spacing: 0; \n                border-radius: 10px;\n                margin-bottom: 20px;\n                overflow: hidden;\n            }\n            th, td { padding: 10px; border-bottom: 1px solid var(--border-color); }\n            td div { display: flex; align-items: center; }\n            th { background-color: var(--secondary-color); color: white; font-weight: bold; font-size: 1.1rem; width: 50%;}\n            td:last-child { background-color: var(--table-active-color); }               \n            tr:hover { background-color: var(--table-active-color); }\n            .modal {\n                display: none;\n                position: fixed;\n                z-index: 1;\n                left: 0;\n                top: 0;\n                width: 100%;\n                height: 100%;\n                overflow: auto;\n                background-color: rgba(0, 0, 0, 0.4);\n            }\n            .modal-content {\n                background-color: var(--form-background-color);\n                margin: auto;\n                padding: 10px 20px 20px;\n                border: 1px solid var(--border-color);\n                border-radius: 10px;\n                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n                width: 80%;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n            }\n            .close { color: var(--color); float: right; font-size: 28px; font-weight: bold; }\n            .close:hover,\n            .close:focus { color: black; text-decoration: none; cursor: pointer; }\n            .form-control label {\n                display: block;\n                margin-bottom: 8px;\n                font-size: 110%;\n                font-weight: 600;\n                color: var(--lable-text-color);\n                line-height: 1.3em;\n            }\n            .form-control input[type="password"] {\n                width: 100%;\n                padding: 10px;\n                border: 1px solid var(--border-color);\n                border-radius: 5px;\n                font-size: 16px;\n                color: var(--lable-text-color);\n                background-color: var(--input-background-color);\n                box-sizing: border-box;\n                margin-bottom: 15px;\n                transition: border-color 0.3s ease;\n            }\n            .routing { \n                display: grid;\n                justify-content: flex-start;\n                grid-template-columns: 1fr 1fr 10fr 1fr;\n                margin-bottom: 15px;\n            }\n            .form-control .routing input { grid-column: 2 / 3; }\n            #routing-rules.form-control { display: grid; grid-template-columns: 1fr 1fr; }\n            .routing label {\n                text-align: left;\n                margin: 0 0 0 10px;\n                font-weight: 400;\n                font-size: 100%;\n                text-wrap: nowrap;\n            }\n            .form-control input[type="password"]:focus { border-color: var(--secondary-color); outline: none; }\n            #passwordError { color: red; margin-bottom: 10px; }\n            .symbol { margin-right: 8px; }\n            .modalQR {\n                display: none;\n                position: fixed;\n                z-index: 1;\n                left: 0;\n                top: 0;\n                width: 100%;\n                height: 100%;\n                overflow: auto;\n                background-color: rgba(0, 0, 0, 0.4);\n            }\n            .floating-button {\n                position: fixed;\n                bottom: 20px;\n                left: 20px;\n                background-color: var(--color);\n                color: white;\n                border: none;\n                border-radius: 50%;\n                width: 60px;\n                height: 60px;\n                font-size: 24px;\n                cursor: pointer;\n                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n                transition: background-color 0.3s, transform 0.3s;\n            }\n            .floating-button:hover { transform: scale(1.1); }\n            .min-max { display: grid; grid-template-columns: 1fr auto 1fr; align-items: baseline; width: 100%; }\n            .min-max span { text-align: center; white-space: pre; }\n            .input-with-select { width: 100%; }\n            body.dark-mode .floating-button { background-color: var(--color); }\n            body.dark-mode .floating-button:hover { transform: scale(1.1); }\n            @media only screen and (min-width: 768px) {\n                .form-container { max-width: 70%; }\n                .form-control { \n                    margin-bottom: 15px;\n                    display: grid;\n                    grid-template-columns: 1fr 1fr;\n                    align-items: baseline;\n                    justify-content: flex-end;\n                    font-family: Arial, sans-serif;\n                }\n                #apply { display: block; margin: 20px auto 0 auto; max-width: 50%; }\n                .modal-content { width: 30% }\n                .routing { display: grid; grid-template-columns: 4fr 1fr 3fr 4fr; }\n            }\n        </style>\n    </head>\n    <body>\n        <h1>BPB Panel <span style="font-size: smaller;">${panelVersion}</span> </h1>\n        <div class="form-container">\n            <form id="configForm">\n                <details open>\n                    <summary><h2>VLESS / TROJAN </h2></summary>\n                    <div class="form-control">\n                        <label for="remoteDNS"> Remote DNS</label>\n                        <input type="url" id="remoteDNS" name="remoteDNS" value="${r}" required>\n                    </div>\n                    <div class="form-control">\n                        <label for="localDNS"> Local DNS</label>\n                        <input type="text" id="localDNS" name="localDNS" value="${o}"\n                            pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)|localhost$"\n                            title="Please enter a valid DNS IP Address or localhost!"  required>\n                    </div>\n                    <div class="form-control">\n                        <label for="vlessTrojanFakeDNS"> Fake DNS</label>\n                        <div class="input-with-select">\n                            <select id="vlessTrojanFakeDNS" name="vlessTrojanFakeDNS">\n                                <option value="true" ${a?"selected":""}>Enabled</option>\n                                <option value="false" ${a?"":"selected"}>Disabled</option>\n                            </select>\n                        </div>\n                    </div>\n                    <div class="form-control">\n                        <label for="proxyIP"> Proxy IP</label>\n                        <input type="text" id="proxyIP" name="proxyIP" value="${s}">\n                    </div>\n                    <div class="form-control">\n                        <label for="outProxy"> Chain Proxy</label>\n                        <input type="text" id="outProxy" name="outProxy" value="${i}">\n                    </div>\n                    <div class="form-control">\n                        <label for="cleanIPs"> Clean IPs</label>\n                        <input type="text" id="cleanIPs" name="cleanIPs" value="${l.replaceAll(","," , ")}">\n                    </div>\n                    <div class="form-control">\n                        <label> IP Scanner</label>\n                        <a href="https://scanner.github1.cloud/" id="scanner" name="scanner" target="_blank" style="width: 100%;">\n                            <button type="button" class="button">\n                                Scan now\n                                <span class="material-symbols-outlined">open_in_new</span>\n                            </button>\n                        </a>\n                    </div>\n                    <div class="form-control">\n                        <label for="enableIPv6"> IPv6 Configs</label>\n                        <div class="input-with-select">\n                            <select id="enableIPv6" name="enableIPv6">\n                                <option value="true" ${c?"selected":""}>Enabled</option>\n                                <option value="false" ${c?"":"selected"}>Disabled</option>\n                            </select>\n                        </div>\n                    </div>\n                    <div class="form-control">\n                        <label for="customCdnAddrs"> Custom CDN Addrs</label>\n                        <input type="text" id="customCdnAddrs" name="customCdnAddrs" value="${d.replaceAll(","," , ")}">\n                    </div>\n                    <div class="form-control">\n                        <label for="customCdnHost"> Custom CDN Host</label> \n                        <input type="text" id="customCdnHost" name="customCdnHost" value="${u}">\n                    </div>\n                    <div class="form-control">\n                        <label for="customCdnSni"> Custom CDN SNI</label>\n                        <input type="text" id="customCdnSni" name="customCdnSni" value="${p}">\n                    </div>\n                    <div class="form-control">\n                        <label for="bestVLESSTrojanInterval"> Best Interval</label>\n                        <input type="number" id="bestVLESSTrojanInterval" name="bestVLESSTrojanInterval" min="10" max="90" value="${h}">\n                    </div>\n                    <div class="form-control" style="padding-top: 10px;">\n                        <label> Protocols</label>\n                        <div style="width: 100%; display: grid; grid-template-columns: 1fr 1fr; align-items: baseline; margin-top: 10px;">\n                            <div style = "display: flex; justify-content: center; align-items: center;">\n                                <input type="checkbox" id="vlessConfigs" name="vlessConfigs" onchange="handleProtocolChange(event)" value="true" ${f?"checked":""}>\n                                <label for="vlessConfigs" style="margin: 0 5px; font-weight: normal; font-size: unset;">VLESS</label>\n                            </div>\n                            <div style = "display: flex; justify-content: center; align-items: center;">\n                                <input type="checkbox" id="trojanConfigs" name="trojanConfigs" onchange="handleProtocolChange(event)" value="true" ${y?"checked":""}>\n                                <label for="trojanConfigs" style="margin: 0 5px; font-weight: normal; font-size: unset;">Trojan</label>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="table-container">\n                        <table id="ports-block">\n                            <tr>\n                                <th style="text-wrap: nowrap; background-color: gray;">Config type</th>\n                                <th style="text-wrap: nowrap; background-color: gray;">Ports</th>\n                            </tr>\n                            <tr>\n                                <td style="text-align: center; font-size: larger;"><b>TLS</b></td>\n                                <td>\n                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">${j}</div>\n                                </td>    \n                            </tr>\n                            ${H?`<tr>\n                                <td style="text-align: center; font-size: larger;"><b>Non TLS</b></td>\n                                <td>\n                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">${H}</div>\n                                </td>    \n                            </tr>`:""}        \n                        </table>\n                    </div>\n                </details>\n                <details>\n                    <summary><h2>FRAGMENT </h2></summary>\t\n                    <div class="form-control">\n                        <label for="fragmentLengthMin"> Length</label>\n                        <div class="min-max">\n                            <input type="number" id="fragmentLengthMin" name="fragmentLengthMin" value="${b}" min="10" required>\n                            <span> - </span>\n                            <input type="number" id="fragmentLengthMax" name="fragmentLengthMax" value="${g}" max="500" required>\n                        </div>\n                    </div>\n                    <div class="form-control">\n                        <label for="fragmentIntervalMin"> Interval</label>\n                        <div class="min-max">\n                            <input type="number" id="fragmentIntervalMin" name="fragmentIntervalMin"\n                                value="${v}" min="1" max="30" required>\n                            <span> - </span>\n                            <input type="number" id="fragmentIntervalMax" name="fragmentIntervalMax"\n                                value="${w}" min="1" max="30" required>\n                        </div>\n                    </div>\n                    <div class="form-control">\n                        <label for="fragmentPackets"> Packets</label>\n                        <div class="input-with-select">\n                            <select id="fragmentPackets" name="fragmentPackets">\n                                <option value="tlshello" ${"tlshello"===S?"selected":""}>tlshello</option>\n                                <option value="1-1" ${"1-1"===S?"selected":""}>1-1</option>\n                                <option value="1-2" ${"1-2"===S?"selected":""}>1-2</option>\n                                <option value="1-3" ${"1-3"===S?"selected":""}>1-3</option>\n                                <option value="1-5" ${"1-5"===S?"selected":""}>1-5</option>\n                            </select>\n                        </div>\n                    </div>\n                </details>\n                <details>\n                    <summary><h2>WARP GENERAL </h2></summary>\n                    <div class="form-control">\n                        <label for="warpEndpoints"> Endpoints</label>\n                        <input type="text" id="warpEndpoints" name="warpEndpoints" value="${x.replaceAll(","," , ")}" required>\n                    </div>\n                    <div class="form-control">\n                        <label style="line-height: 1.5;"> Scan Endpoint</label>\n                        <button type="button" class="button" style="padding: 10px 0;" onclick="copyToClipboard('bash <(curl -fsSL https://raw.githubusercontent.com/Ptechgithub/warp/main/endip/install.sh)', false)">\n                            Copy Script<span class="material-symbols-outlined">terminal</span>\n                        </button>\n                    </div>\n                    <div class="form-control">\n                        <label for="warpFakeDNS"> Fake DNS</label>\n                        <div class="input-with-select">\n                            <select id="warpFakeDNS" name="warpFakeDNS">\n                                <option value="true" ${k?"selected":""}>Enabled</option>\n                                <option value="false" ${k?"":"selected"}>Disabled</option>\n                            </select>\n                        </div>\n                    </div>\n                    <div class="form-control">\n                        <label for="warpPlusLicense"> Warp+ License</label>\n                        <input type="text" id="warpPlusLicense" name="warpPlusLicense" value="${_}" \n                            pattern="^[a-zA-Z0-9]{8}-[a-zA-Z0-9]{8}-[a-zA-Z0-9]{8}$" \n                            title="Please enter a valid Warp Plus license in xxxxxxxx-xxxxxxxx-xxxxxxxx format">\n                    </div>\n                    <div class="form-control">\n                        <label> Warp Configs</label>\n                        <button id="refreshBtn" type="button" class="button" style="padding: 10px 0;" onclick="getWarpConfigs()">\n                            Update<span class="material-symbols-outlined">autorenew</span>\n                        </button>\n                    </div>\n                    <div class="form-control">\n                        <label for="bestWarpInterval"> Best Interval</label>\n                        <input type="number" id="bestWarpInterval" name="bestWarpInterval" min="10" max="90" value="${C}">\n                    </div>\n                </details>\n                <details>\n                    <summary><h2>WARP PRO </h2></summary>\n                    <div class="form-control">\n                        <label for="hiddifyNoiseMode"> Hiddify Mode</label>\n                        <input type="text" id="hiddifyNoiseMode" name="hiddifyNoiseMode" \n                            pattern="^(m[1-6]|h_[0-9A-Fa-f]{2}|g_([0-9A-Fa-f]{2}_){2}[0-9A-Fa-f]{2})$" \n                            title="Enter 'm1-m6', 'h_HEX', 'g_HEX_HEX_HEX' which HEX can be between 00 to ff"\n                            value="${P}" required>\n                    </div>\n                    <div class="form-control">\n                        <label for="nikaNGNoiseMode"> NikaNG Mode</label>\n                        <input type="text" id="nikaNGNoiseMode" name="nikaNGNoiseMode" \n                            pattern="^(none|quic|random|[0-9A-Fa-f]+)$" \n                            title="Enter 'none', 'quic', 'random', or any HEX string like 'ee0000000108aaaa'"\n                            value="${E}" required>\n                    </div>\n                    <div class="form-control">\n                        <label for="noiseCountMin"> Noise Count</label>\n                        <div class="min-max">\n                            <input type="number" id="noiseCountMin" name="noiseCountMin"\n                                value="${A}" min="1" required>\n                            <span> - </span>\n                            <input type="number" id="noiseCountMax" name="noiseCountMax"\n                                value="${T}" min="1" required>\n                        </div>\n                    </div>\n                    <div class="form-control">\n                        <label for="noiseSizeMin"> Noise Size</label>\n                        <div class="min-max">\n                            <input type="number" id="noiseSizeMin" name="noiseSizeMin"\n                                value="${I}" min="1" required>\n                            <span> - </span>\n                            <input type="number" id="noiseSizeMax" name="noiseSizeMax"\n                                value="${D}" min="1" required>\n                        </div>\n                    </div>\n                    <div class="form-control">\n                        <label for="noiseDelayMin"> Noise Delay</label>\n                        <div class="min-max">\n                            <input type="number" id="noiseDelayMin" name="noiseDelayMin"\n                                value="${R}" min="1" required>\n                            <span> - </span>\n                            <input type="number" id="noiseDelayMax" name="noiseDelayMax"\n                                value="${N}" min="1" required>\n                        </div>\n                    </div>\n                </details>\n                <details>\n                    <summary><h2>ROUTING RULES </h2></summary>\n                    <div id="routing-rules" class="form-control" style="margin-bottom: 20px;">\t\t\t\n                        <div class="routing">\n                            <input type="checkbox" id="bypass-lan" name="bypass-lan" value="true" ${$?"checked":""}>\n                            <label for="bypass-lan">Bypass LAN</label>\n                        </div>\n                        <div class="routing">\n                            <input type="checkbox" id="block-ads" name="block-ads" value="true" ${B?"checked":""}>\n                            <label for="block-ads">Block Ads.</label>\n                        </div>\n                        <div class="routing">\n                            <input type="checkbox" id="bypass-iran" name="bypass-iran" value="true" ${W?"checked":""}>\n                            <label for="bypass-iran">Bypass Iran</label>\n                        </div>\n                        <div class="routing">\n                            <input type="checkbox" id="block-porn" name="block-porn" value="true" ${J?"checked":""}>\n                            <label for="block-porn">Block Porn</label>\n                        </div>\n                        <div class="routing">\n                            <input type="checkbox" id="bypass-china" name="bypass-china" value="true" ${M?"checked":""}>\n                            <label for="bypass-china">Bypass China</label>\n                        </div>\n                        <div class="routing">\n                            <input type="checkbox" id="block-udp-443" name="block-udp-443" value="true" ${U?"checked":""}>\n                            <label for="block-udp-443">Block QUIC</label>\n                        </div>\n                        <div class="routing">\n                            <input type="checkbox" id="bypass-russia" name="bypass-russia" value="true" ${O?"checked":""}>\n                            <label for="bypass-russia">Bypass Russia</label>\n                        </div>\n                    </div>\n                </details>\n                <div id="apply" class="form-control">\n                    <div style="grid-column: 2; width: 100%; display: inline-flex;">\n                        <input type="submit" id="applyButton" style="margin-right: 10px;" class="button disabled" value="APPLY SETTINGS " form="configForm">\n                        <button type="button" id="resetSettings" style="background: none; margin: 0; border: none; cursor: pointer;">\n                            <i class="fa fa-refresh fa-2x fa-border" style="border-radius: .2em; border-color: var(--border-color);" aria-hidden="true"></i>\n                        </button>\n                    </div>\n                </div>\n            </form>\n            <hr>            \n            <h2>NORMAL SUB </h2>\n            <div class="table-container">\n                <table id="normal-configs-table">\n                    <tr>\n                        <th>Application</th>\n                        <th>Subscription</th>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>NikaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>MahsaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN-PRO</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Shadowrocket</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Streisand</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Hiddify</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Nekoray (Xray)</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/sub/${userID}#BPB-Normal', 'Normal Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/sub/${userID}#BPB-Normal', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Nekobox</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Nekoray (Sing-Box)</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Karing</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="copyToClipboard('https://${t}/sub/${userID}?app=singbox#BPB-Normal', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                </table>\n            </div>\n            <h2>FULL NORMAL SUB </h2>\n            <div class="table-container">\n                <table id="full-normal-configs-table">\n                    <tr>\n                        <th>Application</th>\n                        <th>Subscription</th>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>NikaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>MahsaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN-PRO</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Streisand</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/sub/${userID}?app=xray#BPB-Full-Normal', 'Full normal Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/sub/${userID}?app=xray#BPB-Full-Normal', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Sing-box</b></span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('sing-box://import-remote-profile?url=https://${t}/sub/${userID}?app=sfa#BPB-Full-Normal', 'Normal Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/sub/${userID}?app=sfa#BPB-Full-Normal', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Clash Meta</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Clash Verge</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>FlClash</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Stash</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/sub/${userID}?app=clash#BPB-Full-Normal', 'Normal Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/sub/${userID}?app=clash#BPB-Full-Normal', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                </table>\n            </div>\n            <h2>FRAGMENT SUB </h2>\n            <div class="table-container">\n                <table id="frag-sub-table">\n                    <tr>\n                        <th style="text-wrap: nowrap;">Application</th>\n                        <th style="text-wrap: nowrap;">Subscription</th>\n                    </tr>\n                    <tr>\n                        <td style="text-wrap: nowrap;">\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>NikaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>MahsaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN-PRO</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Streisand</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/fragsub/${userID}#BPB-Fragment', 'Fragment Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/fragsub/${userID}#BPB-Fragment', true)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style="text-wrap: nowrap;">\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Hiddify</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/fragsub/${userID}?app=hiddify#BPB-Fragment', 'Fragment Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/fragsub/${userID}?app=hiddify#BPB-Fragment', true)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                </table>\n            </div>\n            <h2>WARP SUB </h2>\n            <div class="table-container">\n                <table id="normal-configs-table">\n                    <tr>\n                        <th>Application</th>\n                        <th>Subscription</th>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Streisand</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/warpsub/${userID}?app=xray#BPB-Warp', 'Warp Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/warpsub/${userID}?app=xray#BPB-Warp', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Hiddify</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Singbox</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('sing-box://import-remote-profile?url=https://${t}/warpsub/${userID}?app=singbox#BPB-Warp', 'Warp Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/warpsub/${userID}?app=singbox#BPB-Warp', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Clash Meta</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Clash Verge</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>FlClash</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Stash</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/warpsub/${userID}?app=clash#BPB-Warp', 'Warp Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/warpsub/${userID}?app=clash#BPB-Warp', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                </table>\n            </div>\n            <h2>WARP PRO SUB </h2>\n            <div class="table-container">\n                <table id="warp-pro-configs-table">\n                    <tr>\n                        <th>Application</th>\n                        <th>Subscription</th>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>NikaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>MahsaNG</span>\n                            </div>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>v2rayN-PRO</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('https://${t}/warpsub/${userID}?app=nikang#BPB-Warp-Pro', 'Warp Pro Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/warpsub/${userID}?app=nikang#BPB-Warp-Pro', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <div>\n                                <span class="material-symbols-outlined symbol">verified</span>\n                                <span>Hiddify</span>\n                            </div>\n                        </td>\n                        <td>\n                            <button onclick="openQR('sing-box://import-remote-profile?url=https://${t}/warpsub/${userID}?app=hiddify#BPB-Warp-Pro', 'Warp Pro Subscription')" style="margin-bottom: 8px;">\n                                QR Code&nbsp;<span class="material-symbols-outlined">qr_code</span>\n                            </button>\n                            <button onclick="copyToClipboard('https://${t}/warpsub/${userID}?app=hiddify#BPB-Warp-Pro', false)">\n                                Copy Sub<span class="material-symbols-outlined">format_list_bulleted</span>\n                            </button>\n                        </td>\n                    </tr>\n                </table>\n            </div>\n            <div id="myModal" class="modal">\n                <div class="modal-content">\n                    <span class="close">&times;</span>\n                    <form id="passwordChangeForm">\n                        <h2>Change Password</h2>\n                        <div class="form-control">\n                            <label for="newPassword">New Password</label>\n                            <input type="password" id="newPassword" name="newPassword" required>\n                            </div>\n                        <div class="form-control">\n                            <label for="confirmPassword">Confirm Password</label>\n                            <input type="password" id="confirmPassword" name="confirmPassword" required>\n                        </div>\n                        <div id="passwordError" style="color: red; margin-bottom: 10px;"></div>\n                        <button id="changePasswordBtn" type="submit" class="button">Change Password</button>\n                    </form>\n                </div>\n            </div>\n            <div id="myQRModal" class="modalQR">\n                <div class="modal-content" style="width: auto; text-align: center;">\n                    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 10px;">\n                        <span id="closeQRModal" class="close" style="align-self: flex-end;">&times;</span>\n                        <span id="qrcodeTitle" style="align-self: center; font-weight: bold;"></span>\n                    </div>\n                    <div id="qrcode-container"></div>\n                </div>\n            </div>\n            <hr>\n            <div class="footer">\n                <i class="fa fa-github" style="font-size:36px; margin-right: 10px;"></i>\n                <a class="link" href="https://github.com/bia-pain-bache/BPB-Worker-Panel" style="color: var(--color); text-decoration: underline;" target="_blank">Github</a>\n                <button id="openModalBtn" class="button">Change Password</button>\n                <button type="button" id="logout" style="background: none; color: var(--color); margin: 0; border: none; cursor: pointer;">\n                    <i class="fa fa-power-off fa-2x" aria-hidden="true"></i>\n                </button>\n            </div>\n        </div>\n        <button id="darkModeToggle" class="floating-button">\n            <i id="modeIcon" class="fa fa-2x fa-adjust" style="color: var(--background-color);" aria-hidden="true"></i>\n        </button>   \n    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>\n    <script>\n        const defaultHttpsPorts = ['443', '8443', '2053', '2083', '2087', '2096'];\n        let activePortsNo = ${m.length};\n        let activeHttpsPortsNo = ${m.filter((e=>defaultHttpsPorts.includes(e))).length};\n        let activeProtocols = ${F};\n        const warpPlusLicense = '${_}';\n        localStorage.getItem('darkMode') === 'enabled' && document.body.classList.add('dark-mode');\n\n        document.addEventListener('DOMContentLoaded', async () => {\n            const configForm = document.getElementById('configForm');            \n            const modal = document.getElementById('myModal');\n            const changePass = document.getElementById('openModalBtn');\n            const closeBtn = document.querySelector(".close");\n            const passwordChangeForm = document.getElementById('passwordChangeForm');            \n            const applyBtn = document.getElementById('applyButton');         \n            const initialFormData = new FormData(configForm);\n            const closeQR = document.getElementById('closeQRModal');\n            const resetSettings = document.getElementById('resetSettings');\n            let modalQR = document.getElementById('myQRModal');\n            let qrcodeContainer = document.getElementById('qrcode-container');\n            let forcedPassChange = false;\n            const darkModeToggle = document.getElementById('darkModeToggle');\n                    \n            const hasFormDataChanged = () => {\n                const currentFormData = new FormData(configForm);\n                const currentFormDataEntries = [...currentFormData.entries()];\n\n                const nonCheckboxFieldsChanged = currentFormDataEntries.some(\n                    ([key, value]) => !initialFormData.has(key) || initialFormData.get(key) !== value\n                );\n\n                const checkboxFieldsChanged = Array.from(configForm.elements)\n                    .filter((element) => element.type === 'checkbox')\n                    .some((checkbox) => {\n                    const initialValue = initialFormData.has(checkbox.name)\n                        ? initialFormData.get(checkbox.name)\n                        : false;\n                    const currentValue = currentFormDataEntries.find(([key]) => key === checkbox.name)?.[1] || false;\n                    return initialValue !== currentValue;\n                });\n\n                return nonCheckboxFieldsChanged || checkboxFieldsChanged;\n            };\n            \n            const enableApplyButton = () => {\n                const isChanged = hasFormDataChanged();\n                applyButton.disabled = !isChanged;\n                applyButton.classList.toggle('disabled', !isChanged);\n            };\n                        \n            passwordChangeForm.addEventListener('submit', event => resetPassword(event));\n            document.getElementById('logout').addEventListener('click', event => logout(event));\n            configForm.addEventListener('submit', (event) => applySettings(event, configForm));\n            configForm.addEventListener('input', enableApplyButton);\n            configForm.addEventListener('change', enableApplyButton);\n            changePass.addEventListener('click', () => {\n                forcedPassChange ? closeBtn.style.display = 'none' : closeBtn.style.display = '';\n                modal.style.display = "block";\n                document.body.style.overflow = "hidden";\n                forcedPassChange = false;\n            });        \n            closeBtn.addEventListener('click', () => {\n                modal.style.display = "none";\n                document.body.style.overflow = "";\n            });\n            closeQR.addEventListener('click', () => {\n                modalQR.style.display = "none";\n                qrcodeContainer.lastElementChild.remove();\n            });\n            resetSettings.addEventListener('click', async () => {\n                const confirmReset = confirm(' This will reset all panel settings.\\nAre you sure?');\n                if(!confirmReset) return;\n                const formData = new FormData();\n                formData.append('resetSettings', 'true');\n                try {\n                    document.body.style.cursor = 'wait';\n                    const refreshButtonVal = refreshBtn.innerHTML;\n                    refreshBtn.innerHTML = ' Loading...';\n\n                    const response = await fetch('/panel', {\n                        method: 'POST',\n                        body: formData,\n                        credentials: 'include'\n                    });\n\n                    document.body.style.cursor = 'default';\n                    refreshBtn.innerHTML = refreshButtonVal;\n                    if (response.ok) {\n                        alert(' Panel settings reset to default successfully! ');\n                        window.location.reload(true);\n                    } else {\n                        const errorMessage = await response.text();\n                        console.error(errorMessage, response.status);\n                        alert(' An error occured, Please try again!\\n ' + errorMessage);\n                    }         \n                } catch (error) {\n                    console.error('Error:', error);\n                }\n            });\n            window.onclick = (event) => {\n                if (event.target == modalQR) {\n                    modalQR.style.display = "none";\n                    qrcodeContainer.lastElementChild.remove();\n                }\n            }\n            darkModeToggle.addEventListener('click', () => {\n                const isDarkMode = document.body.classList.toggle('dark-mode');\n                if (isDarkMode) {\n                    localStorage.setItem('darkMode', 'enabled');\n                } else {\n                    localStorage.setItem('darkMode', 'disabled');                \n                }\n            });\n\n            if (${!n}) {\n                forcedPassChange = true;\n                changePass.click();\n            }\n        });\n\n        const getWarpConfigs = async () => {\n            const license = document.getElementById('warpPlusLicense').value;\n            if (license !== warpPlusLicense) {\n                alert(' First APPLY SETTINGS and then update Warp configs!');\n                return false;\n            }\n            const confirmReset = confirm(' Are you sure?');\n            if(!confirmReset) return;\n            const refreshBtn = document.getElementById('refreshBtn');\n\n            try {\n                document.body.style.cursor = 'wait';\n                const refreshButtonVal = refreshBtn.innerHTML;\n                refreshBtn.innerHTML = ' Loading...';\n\n                const response = await fetch('/update-warp', {\n                    method: 'POST',\n                    credentials: 'include'\n                });\n\n                document.body.style.cursor = 'default';\n                refreshBtn.innerHTML = refreshButtonVal;\n                if (response.ok) {\n                    ${L} ? alert(' Warp configs upgraded to PLUS successfully! ') : alert(' Warp configs updated successfully! ');\n                } else {\n                    const errorMessage = await response.text();\n                    console.error(errorMessage, response.status);\n                    alert(' An error occured, Please try again!\\n ' + errorMessage);\n                }         \n            } catch (error) {\n                console.error('Error:', error);\n            } \n        }\n\n        const handlePortChange = (event) => {\n            \n            if(event.target.checked) { \n                activePortsNo++ \n                defaultHttpsPorts.includes(event.target.name) && activeHttpsPortsNo++;\n            } else {\n                activePortsNo--;\n                defaultHttpsPorts.includes(event.target.name) && activeHttpsPortsNo--;\n            }\n\n            if (activePortsNo === 0) {\n                event.preventDefault();\n                event.target.checked = !event.target.checked;\n                alert(" At least one port should be selected! ");\n                activePortsNo = 1;\n                defaultHttpsPorts.includes(event.target.name) && activeHttpsPortsNo++;\n                return false;\n            }\n                \n            if (activeHttpsPortsNo === 0) {\n                event.preventDefault();\n                event.target.checked = !event.target.checked;\n                alert(" At least one TLS(https) port should be selected! ");\n                activeHttpsPortsNo = 1;\n                return false;\n            }\n        }\n        \n        const handleProtocolChange = (event) => {\n            \n            if(event.target.checked) { \n                activeProtocols++ \n            } else {\n                activeProtocols--;\n            }\n\n            if (activeProtocols === 0) {\n                event.preventDefault();\n                event.target.checked = !event.target.checked;\n                alert(" At least one Protocol should be selected! ");\n                activeProtocols = 1;\n                return false;\n            }\n        }\n\n        const openQR = (url, title) => {\n            let qrcodeContainer = document.getElementById("qrcode-container");\n            let qrcodeTitle = document.getElementById("qrcodeTitle");\n            const modalQR = document.getElementById("myQRModal");\n            qrcodeTitle.textContent = title;\n            modalQR.style.display = "block";\n            let qrcodeDiv = document.createElement("div");\n            qrcodeDiv.className = "qrcode";\n            qrcodeDiv.style.padding = "2px";\n            qrcodeDiv.style.backgroundColor = "#ffffff";\n            new QRCode(qrcodeDiv, {\n                text: url,\n                width: 256,\n                height: 256,\n                colorDark: "#000000",\n                colorLight: "#ffffff",\n                correctLevel: QRCode.CorrectLevel.H\n            });\n            qrcodeContainer.appendChild(qrcodeDiv);\n        }\n\n        const copyToClipboard = (text, decode) => {\n            const textarea = document.createElement('textarea');\n            const value = decode ? decodeURIComponent(text) : text;\n            textarea.value = value;\n            document.body.appendChild(textarea);\n            textarea.select();\n            document.execCommand('copy');\n            document.body.removeChild(textarea);\n            alert(' Copied to clipboard:\\n\\n' +  value);\n        }\n\n        const applySettings = async (event, configForm) => {\n            event.preventDefault();\n            event.stopPropagation();\n            const applyButton = document.getElementById('applyButton');\n            const getValue = (id) => parseInt(document.getElementById(id).value, 10);              \n            const lengthMin = getValue('fragmentLengthMin');\n            const lengthMax = getValue('fragmentLengthMax');\n            const intervalMin = getValue('fragmentIntervalMin');\n            const intervalMax = getValue('fragmentIntervalMax');\n            const proxyIP = document.getElementById('proxyIP').value?.trim();\n            const cleanIP = document.getElementById('cleanIPs');\n            const customCdnAddrs = document.getElementById('customCdnAddrs').value?.split(',').filter(addr => addr !== '');\n            const customCdnHost = document.getElementById('customCdnHost').value;\n            const customCdnSni = document.getElementById('customCdnSni').value;\n            const isCustomCdn = customCdnAddrs.length > 0 || customCdnHost !== '' || customCdnSni !== '';\n            const warpEndpoints = document.getElementById('warpEndpoints').value?.replaceAll(' ', '').split(',');\n            const noiseCountMin = getValue('noiseCountMin');\n            const noiseCountMax = getValue('noiseCountMax');\n            const noiseSizeMin = getValue('noiseSizeMin');\n            const noiseSizeMax = getValue('noiseSizeMax');\n            const noiseDelayMin = getValue('noiseDelayMin');\n            const noiseDelayMax = getValue('noiseDelayMax');\n            const cleanIPs = cleanIP.value?.split(',');\n            const chainProxy = document.getElementById('outProxy').value?.trim();                    \n            const formData = new FormData(configForm);\n            const isVless = /vless:\\/\\/[^s@]+@[^\\s:]+:[^\\s]+/.test(chainProxy);\n            const isSocksHttp = /^(http|socks):\\/\\/(?:([^:@]+):([^:@]+)@)?([^:@]+):(\\d+)$/.test(chainProxy);\n            const hasSecurity = /security=/.test(chainProxy);\n            const securityRegex = /security=(tls|none|reality)/;\n            const validSecurityType = securityRegex.test(chainProxy);\n            let match = chainProxy.match(securityRegex);\n            const securityType = match ? match[1] : null;\n            match = chainProxy.match(/:(\\d+)\\?/);\n            const vlessPort = match ? match[1] : null;\n            const validTransmission = /type=(tcp|grpc|ws)/.test(chainProxy);\n            const validIPDomain = /^((?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\\.)+[a-zA-Z]{2,})|(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)|\\[(?:[a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,7}:\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,6}:[a-fA-F0-9]{1,4}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,5}(?::[a-fA-F0-9]{1,4}){1,2}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,4}(?::[a-fA-F0-9]{1,4}){1,3}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,3}(?::[a-fA-F0-9]{1,4}){1,4}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,2}(?::[a-fA-F0-9]{1,4}){1,5}\\]|\\[[a-fA-F0-9]{1,4}:(?::[a-fA-F0-9]{1,4}){1,6}\\]|\\[:(?::[a-fA-F0-9]{1,4}){1,7}\\]|\\[\\](?:::[a-fA-F0-9]{1,4}){1,7}\\])$/i;\n            const checkedPorts = Array.from(document.querySelectorAll('input[id^="port-"]:checked')).map(input => input.id.split('-')[1]);\n            const validEndpoint = /^(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\\.)+[a-zA-Z]{2,}|(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)|\\[(?:[a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,7}:\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,6}:[a-fA-F0-9]{1,4}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,5}(?::[a-fA-F0-9]{1,4}){1,2}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,4}(?::[a-fA-F0-9]{1,4}){1,3}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,3}(?::[a-fA-F0-9]{1,4}){1,4}\\]|\\[(?:[a-fA-F0-9]{1,4}:){1,2}(?::[a-fA-F0-9]{1,4}){1,5}\\]|\\[[a-fA-F0-9]{1,4}:(?::[a-fA-F0-9]{1,4}){1,6}\\]|\\[:(?::[a-fA-F0-9]{1,4}){1,7}\\]|\\[::(?::[a-fA-F0-9]{1,4}){0,7}\\]):(?:[0-9]{1,5})$/;\n            formData.append('ports', checkedPorts);\n            configForm.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {\n                !formData.has(checkbox.name) && formData.append(checkbox.name, 'false');    \n            });\n\n            const invalidIPs = [...cleanIPs, proxyIP, ...customCdnAddrs, customCdnHost, customCdnSni]?.filter(value => {\n                if (value !== "") {\n                    const trimmedValue = value.trim();\n                    return !validIPDomain.test(trimmedValue);\n                }\n            });\n\n            const invalidEndpoints = warpEndpoints?.filter(value => {\n                if (value !== "") {\n                    const trimmedValue = value.trim();\n                    return !validEndpoint.test(trimmedValue);\n                }\n            });\n\n            if (invalidIPs.length) {\n                alert(' Invalid IPs or Domains \\n\\n' + invalidIPs.map(ip => ' ' + ip).join('\\n'));\n                return false;\n            }\n            \n            if (invalidEndpoints.length) {\n                alert(' Invalid endpoint \\n\\n' + invalidEndpoints.map(endpoint => ' ' + endpoint).join('\\n'));\n                return false;\n            }\n\n            if (lengthMin >= lengthMax || intervalMin > intervalMax || noiseCountMin > noiseCountMax || noiseSizeMin > noiseSizeMax || noiseDelayMin > noiseDelayMax) {\n                alert(' Minimum should be smaller or equal to Maximum! ');               \n                return false;\n            }\n\n            if (!(isVless && (hasSecurity && validSecurityType || !hasSecurity) && validTransmission) && !isSocksHttp && chainProxy) {\n                alert(' Invalid Config!  \\n - The chain proxy should be VLESS, Socks or Http!\\n - VLESS transmission should be GRPC,WS or TCP\\n - VLESS security should be TLS,Reality or None\\n - socks or http should be like:\\n + (socks or http)://user:pass@host:port\\n + (socks or http)://host:port');               \n                return false;\n            }\n\n            if (isVless && securityType === 'tls' && vlessPort !== '443') {\n                alert(' VLESS TLS port can be only 443 to be used as a proxy chain! ');               \n                return false;\n            }\n\n            if (isCustomCdn && !(customCdnAddrs.length > 0 && customCdnHost && customCdnSni)) {\n                alert(' All "Custom" fields should be filled or deleted together! ');               \n                return false;\n            }\n\n            try {\n                document.body.style.cursor = 'wait';\n                const applyButtonVal = applyButton.value;\n                applyButton.value = ' Loading...';\n\n                const response = await fetch('/panel', {\n                    method: 'POST',\n                    body: formData,\n                    credentials: 'include'\n                });\n\n                document.body.style.cursor = 'default';\n                applyButton.value = applyButtonVal;\n\n                if (response.ok) {\n                    alert(' Parameters applied successfully ');\n                    window.location.reload(true);\n                } else {\n                    const errorMessage = await response.text();\n                    console.error(errorMessage, response.status);\n                    alert(' Session expired! Please login again.');\n                    window.location.href = '/login';\n                }           \n            } catch (error) {\n                console.error('Error:', error);\n            }\n        }\n\n        const logout = async (event) => {\n            event.preventDefault();\n\n            try {\n                const response = await fetch('/logout', {\n                    method: 'GET',\n                    credentials: 'same-origin'\n                });\n            \n                if (response.ok) {\n                    window.location.href = '/login';\n                } else {\n                    console.error('Failed to log out:', response.status);\n                }\n            } catch (error) {\n                console.error('Error:', error);\n            }\n        }\n\n        const resetPassword = async (event) => {\n            event.preventDefault();\n            const modal = document.getElementById('myModal');\n            const newPasswordInput = document.getElementById('newPassword');\n            const confirmPasswordInput = document.getElementById('confirmPassword');\n            const passwordError = document.getElementById('passwordError');             \n            const newPassword = newPasswordInput.value;\n            const confirmPassword = confirmPasswordInput.value;\n\n            if (newPassword !== confirmPassword) {\n                passwordError.textContent = "Passwords do not match";\n                return false;\n            }\n\n            const hasCapitalLetter = /[A-Z]/.test(newPassword);\n            const hasNumber = /[0-9]/.test(newPassword);\n            const isLongEnough = newPassword.length >= 8;\n\n            if (!(hasCapitalLetter && hasNumber && isLongEnough)) {\n                passwordError.textContent = ' Password must contain at least one capital letter, one number, and be at least 8 characters long.';\n                return false;\n            }\n                    \n            try {\n                const response = await fetch('/panel/password', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'text/plain'\n                    },\n                    body: newPassword,\n                    credentials: 'same-origin'\n                });\n            \n                if (response.ok) {\n                    modal.style.display = "none";\n                    document.body.style.overflow = "";\n                    alert(" Password changed successfully! ");\n                    window.location.href = '/login';\n                } else if (response.status === 401) {\n                    const errorMessage = await response.text();\n                    passwordError.textContent = ' ' + errorMessage;\n                    console.error(errorMessage, response.status);\n                    alert(' Session expired! Please login again.');\n                    window.location.href = '/login';\n                } else {\n                    const errorMessage = await response.text();\n                    passwordError.textContent = ' ' + errorMessage;\n                    console.error(errorMessage, response.status);\n                    return false;\n                }\n            } catch (error) {\n                console.error('Error:', error);\n            }\n        }\n    <\/script>\n    </body>\t\n    </html>`}function renderLoginPage(){return`\n    <!DOCTYPE html>\n    <html lang="en">\n    <head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>User Login</title>\n    <style>\n        :root {\n            --color: black;\n            --primary-color: #09639f;\n            --header-color: #09639f; \n            --background-color: #fff;\n            --form-background-color: #f9f9f9;\n            --lable-text-color: #333;\n            --h2-color: #3b3b3b;\n            --border-color: #ddd;\n            --input-background-color: white;\n            --header-shadow: 2px 2px 4px rgba(0, 0, 0, 0.25);\n        }\n        html, body { height: 100%; margin: 0; }\n        body {\n            font-family: system-ui;\n            background-color: var(--background-color);\n            position: relative;\n            overflow: hidden;\n        }\n        body.dark-mode {\n            --color: white;\n            --primary-color: #09639F;\n            --header-color: #3498DB; \n            --background-color: #121212;\n            --form-background-color: #121212;\n            --lable-text-color: #DFDFDF;\n            --h2-color: #D5D5D5;\n            --border-color: #353535;\n            --input-background-color: #252525;\n            --header-shadow: 2px 2px 4px rgba(255, 255, 255, 0.25);\n        }\n        html, body { height: 100%; margin: 0; }\n        .container {\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            width: 90%;\n        }\n        h1 { font-size: 2.5rem; text-align: center; color: var(--header-color); margin: 0 auto 30px; text-shadow: var(--header-shadow); }        \n        h2 { text-align: center; color: var(--h2-color) }\n        .form-container {\n            background: var(--form-background-color);\n            border: 1px solid var(--border-color);\n            border-radius: 10px;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n            padding: 20px;\n        }\n        .form-control { margin-bottom: 15px; display: flex; align-items: center; }\n        label {\n            display: block;\n            margin-bottom: 5px;\n            padding-right: 20px;\n            font-size: 110%;\n            font-weight: 600;\n            color: var(--lable-text-color);\n        }\n        input[type="text"],\n        input[type="password"] {\n            width: 100%;\n            padding: 10px;\n            border: 1px solid var(--border-color);\n            border-radius: 5px;\n            color: var(--lable-text-color);\n            background-color: var(--input-background-color);\n        }\n        button {\n            display: block;\n            width: 100%;\n            padding: 10px;\n            font-size: 16px;\n            font-weight: 600;\n            border: none;\n            border-radius: 5px;\n            color: white;\n            background-color: var(--primary-color);\n            cursor: pointer;\n            transition: background-color 0.3s ease;\n        }\n        .button:hover,\n        button:focus {\n            background-color: #2980b9;\n            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);\n            transform: translateY(-2px);\n        }\n        button.button:hover { color: white; }\n        .button:active { transform: translateY(1px); box-shadow: 0 3px 7px rgba(0, 0, 0, 0.3); }\n        @media only screen and (min-width: 768px) {\n            .container { width: 30%; }\n        }\n    </style>\n    </head>\n    <body>\n        <div class="container">\n            <h1>BPB Panel <span style="font-size: smaller;">${panelVersion}</span> </h1>\n            <div class="form-container">\n                <h2>User Login</h2>\n                <form id="loginForm">\n                    <div class="form-control">\n                        <label for="password">Password</label>\n                        <input type="password" id="password" name="password" required>\n                    </div>\n                    <div id="passwordError" style="color: red; margin-bottom: 10px;"></div>\n                    <button type="submit" class="button">Login</button>\n                </form>\n            </div>\n        </div>\n    <script>\n        localStorage.getItem('darkMode') === 'enabled' && document.body.classList.add('dark-mode');\n        document.getElementById('loginForm').addEventListener('submit', async (event) => {\n            event.preventDefault();\n            const password = document.getElementById('password').value;\n\n            try {\n                const response = await fetch('/login', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'text/plain'\n                    },\n                    body: password\n                });\n            \n                if (response.ok) {\n                    window.location.href = '/panel';\n                } else {\n                    passwordError.textContent = ' Wrong Password!';\n                    const errorMessage = await response.text();\n                    console.error('Login failed:', errorMessage);\n                }\n            } catch (error) {\n                console.error('Error during login:', error);\n            }\n        });\n    <\/script>\n    </body>\n    </html>`}function renderErrorPage(e,t,n){return`\n    <!DOCTYPE html>\n    <html lang="en">\n    <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <title>Error Page</title>\n        <style>\n            :root {\n                --color: black;\n                --header-color: #09639f; \n                --background-color: #fff;\n                --border-color: #ddd;\n                --header-shadow: 2px 2px 4px rgba(0, 0, 0, 0.25);\n            }\n            body, html {\n                height: 100%;\n                width: 100%;\n                margin: 0;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                font-family: system-ui;\n                color: var(--color);\n                background-color: var(--background-color);\n            }\n            body.dark-mode {\n                --color: white;\n                --header-color: #3498DB; \n                --background-color: #121212;\n                --header-shadow: 2px 2px 4px rgba(255, 255, 255, 0.25);          \n            }\n            h1 { font-size: 2.5rem; text-align: center; color: var(--header-color); text-shadow: var(--header-shadow); }\n            #error-container { text-align: center; }\n        </style>\n    </head>\n    <body>\n        <div id="error-container">\n            <h1>BPB Panel <span style="font-size: smaller;">${panelVersion}</span> </h1>\n            <div id="error-message">\n                <h2>${e} ${n?'Please try again or refer to <a href="https://github.com/bia-pain-bache/BPB-Worker-Panel/blob/main/README.md">documents</a>':""}\n                </h2>\n                <p><b>${t?` ${t.stack.toString()}`:""}</b></p>\n            </div>\n        </div>\n    <script>\n        localStorage.getItem('darkMode') === 'enabled' && document.body.classList.add('dark-mode');\n    <\/script>\n    </body>\n    </html>`}function extractChainProxyParams(e){let t={};if(!e)return null;let n=new URL(e);const r=n.protocol.slice(0,-1);if("vless"===r){const e=new URLSearchParams(n.search);t={protocol:r,uuid:n.username,hostName:n.hostname,port:n.port},e.forEach(((e,n)=>{t[n]=e}))}else t={protocol:r,user:n.username,pass:n.password,host:n.host,port:n.port};return JSON.stringify(t)}async function fetchWgConfig(e,t){let n=[];const r="https://api.cloudflareclient.com/v0a4005/reg",{warpPlusLicense:o}=t,a=[generateKeyPair(),generateKeyPair()];for(let e=0;e<2;e++){const t=await fetch(r,{method:"POST",headers:{"User-Agent":"insomnia/8.6.1","Content-Type":"application/json"},body:JSON.stringify({key:a[e].publicKey,install_id:"",fcm_token:"",tos:(new Date).toISOString(),type:"Android",model:"PC",locale:"en_US",warp_enabled:!0})}),s=await t.json();if(n.push({privateKey:a[e].privateKey,account:s}),o){const t=await fetch(`${r}/${s.id}/account`,{method:"PUT",headers:{"User-Agent":"insomnia/8.6.1","Content-Type":"application/json",Authorization:`Bearer ${s.token}`},body:JSON.stringify({key:a[e].publicKey,install_id:"",fcm_token:"",tos:(new Date).toISOString(),type:"Android",model:"PC",locale:"en_US",warp_enabled:!0,license:o})}),n=await t.json();if(200!==t.status&&!n.success)return{error:n.errors[0]?.message,configs:null}}}const s=JSON.stringify(n);return await e.bpb.put("warpConfigs",s),{error:null,configs:s}}function extractWireguardParams(e,t){const n=t?1:0,r=e[n].account.config;return{warpIPv6:`${r.interface.addresses.v6}/128`,reserved:r.client_id,publicKey:r.peers[0].public_key,privateKey:e[n].privateKey}}async function buildXrayDNS(e,t,n,r,o){const{remoteDNS:a,resolvedRemoteDNS:s,localDNS:i,vlessTrojanFakeDNS:l,warpFakeDNS:c,blockAds:d,bypassIran:u,bypassChina:p,blockPorn:h,bypassRussia:f}=e,y=u||p||f,m=l&&!o||c&&o,b=t.filter((e=>isDomain(e))),g=b.length>0,v=b.map((e=>`full:${e}`));let w={hosts:{"domain:googleapis.cn":["googleapis.com"]},servers:o?["1.1.1.1","1.0.0.1"]:r?["https://cloudflare-dns.com/dns-query"]:[a],tag:"dns"};const S=n?await resolveDNS(n):void 0;if(S&&(w.hosts[n]=[...S.ipv4,...S.ipv6]),!s.server||r||o||(w.hosts[s.server]=s.staticIPs),r){const e=await resolveDNS("cloudflare-dns.com"),t=await resolveDNS("cloudflare.com"),n=await resolveDNS("www.speedtest.net.cdn.cloudflare.net"),r=await resolveDNS("ben.ns.cloudflare.com"),o=await resolveDNS("lara.ns.cloudflare.com");w.hosts["cloudflare-dns.com"]=[...e.ipv4,...t.ipv4,...n.ipv4,...r.ipv4,...o.ipv4]}d&&(w.hosts["geosite:category-ads-all"]=["127.0.0.1"],w.hosts["geosite:category-ads-ir"]=["127.0.0.1"]),h&&(w.hosts["geosite:category-porn"]=["127.0.0.1"]),g&&w.servers.push({address:"localhost"===i?"8.8.8.8":i,domains:v});let x={address:i,domains:[],expectIPs:[]};return!r&&y&&(u&&x.domains.push("geosite:category-ir")&&x.expectIPs.push("geoip:ir"),p&&x.domains.push("geosite:cn")&&x.expectIPs.push("geoip:cn"),f&&x.domains.push("geosite:category-ru")&&x.expectIPs.push("geoip:ru"),w.servers.push(x)),m&&(!y&&!g||r?w.servers.unshift("fakedns"):w.servers.unshift({address:"fakedns",domains:[...x.domains,...v]})),w}function buildXrayRoutingRules(e,t,n,r,o){const{localDNS:a,bypassLAN:s,bypassIran:i,bypassChina:l,bypassRussia:c,blockAds:d,blockPorn:u,blockUDP443:p}=e,h=i||l||c||s,f=t.filter((e=>isDomain(e))).length>0;let y=[{inboundTag:["dns-in"],outboundTag:"dns-out",type:"field"},{inboundTag:["socks-in","http-in"],port:"53",outboundTag:"dns-out",type:"field"}];if(!o&&(f||"localhost"!==a&&h)&&y.push({ip:["localhost"===a?"8.8.8.8":a],port:"53",outboundTag:"direct",type:"field"}),h&&!o){let e={ip:[],outboundTag:"direct",type:"field"},t={domain:[],outboundTag:"direct",type:"field"};s&&t.domain.push("geosite:private")&&e.ip.push("geoip:private"),i&&t.domain.push("geosite:category-ir")&&e.ip.push("geoip:ir"),l&&t.domain.push("geosite:cn")&&e.ip.push("geoip:cn"),c&&t.domain.push("geosite:category-ru")&&e.ip.push("geoip:ru"),y.push(t,e)}if(p&&y.push({network:"udp",port:"443",outboundTag:"block",type:"field"}),d||u){let e={domain:[],outboundTag:"block",type:"field"};d&&e.domain.push("geosite:category-ads-all","geosite:category-ads-ir"),u&&e.domain.push("geosite:category-porn"),y.push(e)}return r?y.push({network:"tcp,udp",balancerTag:"all",type:"field"}):y.push({network:"tcp,udp",outboundTag:n?"chain":o?"fragment":"proxy",type:"field"}),y}function buildXrayVLESSOutbound(e,t,n,r,o,a,s,i){let l={protocol:"vless",settings:{vnext:[{address:t,port:+n,users:[{id:userID,encryption:"none",level:8}]}]},streamSettings:{network:"ws",security:"none",sockopt:{},wsSettings:{headers:{Host:r,"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"},path:`/${getRandomPath(16)}${a?`/${btoa(a)}`:""}?ed=2560`}},tag:e};return defaultHttpsPorts.includes(n)&&(l.streamSettings.security="tls",l.streamSettings.tlsSettings={allowInsecure:i,fingerprint:"randomized",alpn:["h2","http/1.1"],serverName:o}),s?l.streamSettings.sockopt.dialerProxy="fragment":(l.streamSettings.sockopt.tcpKeepAliveIdle=100,l.streamSettings.sockopt.tcpNoDelay=!0),l}function buildXrayTrojanOutbound(e,t,n,r,o,a,s,i){let l={protocol:"trojan",settings:{servers:[{address:t,port:+n,password:trojanPassword,level:8}]},streamSettings:{network:"ws",security:"none",sockopt:{},wsSettings:{headers:{Host:r},path:`/tr${getRandomPath(16)}${a?`/${btoa(a)}`:""}?ed=2560`}},tag:e};return defaultHttpsPorts.includes(n)&&(l.streamSettings.security="tls",l.streamSettings.tlsSettings={allowInsecure:i,fingerprint:"randomized",alpn:["h2","http/1.1"],serverName:o}),s?l.streamSettings.sockopt.dialerProxy="fragment":(l.streamSettings.sockopt.tcpKeepAliveIdle=100,l.streamSettings.sockopt.tcpNoDelay=!0),l}function buildXrayWarpOutbound(e,t,n,r,o){const{nikaNGNoiseMode:a,noiseCountMin:s,noiseCountMax:i,noiseSizeMin:l,noiseSizeMax:c,noiseDelayMin:d,noiseDelayMax:u}=e,{warpIPv6:p,reserved:h,publicKey:f,privateKey:y}=extractWireguardParams(t,r);let m={protocol:"wireguard",settings:{address:["172.16.0.2/32",p],mtu:1280,peers:[{endpoint:n,publicKey:f,keepAlive:5}],reserved:base64ToDecimal(h),secretKey:y},streamSettings:{sockopt:{dialerProxy:"proxy",tcpKeepAliveIdle:100,tcpNoDelay:!0}},tag:r?"chain":"proxy"};return!r&&delete m.streamSettings,"nikang"===o&&!r&&Object.assign(m.settings,{wnoise:a,wnoisecount:s===i?s:`${s}-${i}`,wpayloadsize:l===c?l:`${l}-${c}`,wnoisedelay:d===u?d:`${d}-${u}`}),m}function buildXrayChainOutbound(e){if(["socks","http"].includes(e.protocol)){const{protocol:t,host:n,port:r,user:o,pass:a}=e;return{protocol:t,settings:{servers:[{address:n,port:+r,users:[{user:o,pass:a,level:8}]}]},streamSettings:{network:"tcp",sockopt:{dialerProxy:"proxy",tcpNoDelay:!0}},mux:{enabled:!0,concurrency:8,xudpConcurrency:16,xudpProxyUDP443:"reject"},tag:"chain"}}const{hostName:t,port:n,uuid:r,flow:o,security:a,type:s,sni:i,fp:l,alpn:c,pbk:d,sid:u,spx:p,headerType:h,host:f,path:y,authority:m,serviceName:b,mode:g}=e;let v={mux:{concurrency:8,enabled:!0,xudpConcurrency:16,xudpProxyUDP443:"reject"},protocol:"vless",settings:{vnext:[{address:t,port:+n,users:[{encryption:"none",flow:o,id:r,level:8,security:"auto"}]}]},streamSettings:{network:s,security:a,sockopt:{dialerProxy:"proxy",tcpNoDelay:!0}},tag:"chain"};if("tls"===a){const e=c?c?.split(","):[];v.streamSettings.tlsSettings={allowInsecure:!1,fingerprint:l,alpn:e,serverName:i}}if("reality"===a&&(delete v.mux,v.streamSettings.realitySettings={fingerprint:l,publicKey:d,serverName:i,shortId:u,spiderX:p}),"http"===h){const e=y?.split(","),t=f?.split(",");v.streamSettings.tcpSettings={header:{request:{headers:{Host:t},method:"GET",path:e,version:"1.1"},response:{headers:{"Content-Type":["application/octet-stream"]},reason:"OK",status:"200",version:"1.1"},type:"http"}}}return"tcp"!==s||"reality"===a||h||(v.streamSettings.tcpSettings={header:{type:"none"}}),"ws"===s&&(v.streamSettings.wsSettings={headers:{Host:f},path:y}),"grpc"===s&&(delete v.mux,v.streamSettings.grpcSettings={authority:m,multiMode:"multi"===g,serviceName:b}),v}function buildXrayConfig(e,t,n,r,o,a,s){const{vlessTrojanFakeDNS:i,warpFakeDNS:l,bestVLESSTrojanInterval:c,bestWarpInterval:d,lengthMin:u,lengthMax:p,intervalMin:h,intervalMax:f,fragmentPackets:y}=e,m=i&&!s||l&&s;let b=structuredClone(xrayConfigTemp);if(b.remarks=t,m?(b.inbounds[0].sniffing.destOverride.push("fakedns"),b.inbounds[1].sniffing.destOverride.push("fakedns")):delete b.fakedns,n){const e=b.outbounds[0].settings.fragment;e.length=`${u}-${p}`,e.interval=`${h}-${f}`,e.packets=y}else b.outbounds.shift();if(r){const e=s?d:c;b.observatory.probeInterval=`${e}s`,b.observatory.subjectSelector=[o?"chain":"prox"],b.routing.balancers[0].selector=[o?"chain":"prox"],a&&(b.routing.balancers[0].fallbackTag=a)}else delete b.observatory,delete b.routing.balancers;return b}async function buildXrayBestPingConfig(e,t,n,r,o){let a=buildXrayConfig(e,o?" BPB F - Best Ping ":" BPB - Best Ping ",o,!0,n,n?"chain-2":"prox-2");return a.dns=await buildXrayDNS(e,t,void 0),a.routing.rules=buildXrayRoutingRules(e,t,n,!0,!1),a.outbounds.unshift(...r),a}async function buildXrayBestFragmentConfig(e,t,n,r){let o=buildXrayConfig(e," BPB F - Best Fragment ",!0,!0,n,void 0,!1);o.dns=await buildXrayDNS(e,[],t),o.routing.rules=buildXrayRoutingRules(e,[],n,!0,!1);const a=o.outbounds.shift();let s=[];return["10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100","10-30","20-40","30-50","40-60","50-70","60-80","70-90","80-100","100-200"].forEach(((e,t)=>{if(n){let e=structuredClone(n);e.tag=`chain-${t+1}`,e.streamSettings.sockopt.dialerProxy=`prox-${t+1}`,s.push(e)}let o=structuredClone(r[n?1:0]);o.tag=`prox-${t+1}`,o.streamSettings.sockopt.dialerProxy=`frag-${t+1}`;let i=structuredClone(a);i.tag=`frag-${t+1}`,i.settings.fragment.length=e,i.settings.fragment.interval="1-1",s.push(o,i)})),o.outbounds.unshift(...s),o}async function buildXrayWorkerLessConfig(e){let t=buildXrayConfig(e," BPB F - WorkerLess ",!0,!1,!1,void 0,!1);t.dns=await buildXrayDNS(e,[],void 0,!0),t.routing.rules=buildXrayRoutingRules(e,[],!1,!1,!0);let n=buildXrayVLESSOutbound("fake-outbound","google.com","443",userID,"google.com","google.com","",!0,!1);return delete n.streamSettings.sockopt,n.streamSettings.wsSettings.path="/",t.outbounds.push(n),t}async function getXrayCustomConfigs(e,t,n,r){let o,a=[],s=[],i=[];const{proxyIP:l,outProxy:c,outProxyParams:d,cleanIPs:u,enableIPv6:p,customCdnAddrs:h,customCdnHost:f,customCdnSni:y,vlessConfigs:m,trojanConfigs:b,ports:g}=t;if(c){const n=JSON.parse(d);try{o=buildXrayChainOutbound(n)}catch(n){console.log("An error occured while parsing chain proxy: ",n),o=void 0,await e.bpb.put("proxySettings",JSON.stringify({...t,outProxy:"",outProxyParams:""}))}}const v=await getConfigAddresses(n,u,p),w=h?h.split(","):[],S=r?[...v]:[...v,...w],x=g.filter((e=>!r||defaultHttpsPorts.includes(e)));m&&i.push("VLESS"),b&&i.push("Trojan");let k=1;for(const e of i){let i=1;for(const c of x)for(const d of S){const p=w.includes(d),h=p?"C":r?"F":"",m=p?y:randomUpperCase(n),b=p?f:n;let g=buildXrayConfig(t,generateRemark(i,c,d,u,e,h),r,!1,o,void 0,!1);g.dns=await buildXrayDNS(t,[d],void 0),g.routing.rules=buildXrayRoutingRules(t,[d],o,!1,!1);let v="VLESS"===e?buildXrayVLESSOutbound("proxy",d,c,b,m,l,r,p):buildXrayTrojanOutbound("proxy",d,c,b,m,l,r,p);if(g.outbounds.unshift({...v}),v.tag=`prox-${k}`,o){g.outbounds.unshift(o);let e=structuredClone(o);e.tag=`chain-${k}`,e.streamSettings.sockopt.dialerProxy=`prox-${k}`,s.push(e)}s.push(v),a.push(g),k++,i++}}const _=await buildXrayBestPingConfig(t,S,o,s,r);if(!r)return[...a,_];const C=await buildXrayBestFragmentConfig(t,n,o,s),P=await buildXrayWorkerLessConfig(t);return a.push(_,C,P),a}async function getXrayWarpConfigs(e,t,n){let r=[],o=[],a=[],s=[];const{warpEndpoints:i}=e,l=i.split(",").map((e=>e.split(":")[0])).filter((e=>isDomain(e))),c="nikang"===n?" Pro ":" ";for(const[l,d]of i.split(",").entries()){const i=d.split(":")[0];let u=buildXrayConfig(e,` ${l+1} - Warp${c}`,!1,!1,!1,void 0,!0),p=buildXrayConfig(e,` ${l+1} - WoW${c}`,!1,!1,!0,void 0,!0);u.dns=p.dns=await buildXrayDNS(e,[i],void 0,!1,!0),u.routing.rules=buildXrayRoutingRules(e,[i],!1,!1,!1),p.routing.rules=buildXrayRoutingRules(e,[i],!0,!1,!1);const h=buildXrayWarpOutbound(e,t,d,!1,n),f=buildXrayWarpOutbound(e,t,d,!0,n);h.settings.peers[0].endpoint=d,f.settings.peers[0].endpoint=d,u.outbounds.unshift(h),p.outbounds.unshift(f,h),r.push(u),o.push(p);const y=structuredClone(h);y.tag=`prox-${l+1}`;const m=structuredClone(f);m.tag=`chain-${l+1}`,m.streamSettings.sockopt.dialerProxy=`prox-${l+1}`,a.push(y),s.push(m)}const d=await buildXrayDNS(e,l,void 0,!1,!0);let u=buildXrayConfig(e,` Warp${c}- Best Ping `,!1,!0,!1,void 0,!0);u.dns=d,u.routing.rules=buildXrayRoutingRules(e,l,!1,!0,!1),u.outbounds.unshift(...a);let p=buildXrayConfig(e,` WoW${c}- Best Ping `,!1,!0,!0,void 0,!0);return p.dns=d,p.routing.rules=buildXrayRoutingRules(e,l,!0,!0,!1),p.outbounds.unshift(...s,...a),[...r,...o,u,p]}async function buildClashDNS(e,t){const{remoteDNS:n,resolvedRemoteDNS:r,localDNS:o,vlessTrojanFakeDNS:a,warpFakeDNS:s,bypassLAN:i,bypassIran:l,bypassChina:c,bypassRussia:d}=e;let u="localhost"===o?"system":o;const p=a&&!t||s&&t;let h={enable:!0,listen:"0.0.0.0:1053",ipv6:!0,"respect-rules":!0,nameserver:t?["1.1.1.1","1.0.0.1"]:[n],"proxy-server-nameserver":[u]};r.server&&!t&&(h.hosts={[r.server]:r.staticIPs});let f=[];return i&&f.push("private"),l&&f.push("category-ir"),c&&f.push("cn"),d&&f.push("category-ru"),(l||c||i||d)&&(h["nameserver-policy"]={[`geosite:${f.join(",")}`]:[u],"www.gstatic.com":[u]}),p&&(h["enhanced-mode"]="fake-ip",h["fake-ip-range"]="198.18.0.1/16"),h}function buildClashRoutingRules(e){let t=[];const{localDNS:n,bypassLAN:r,bypassIran:o,bypassChina:a,bypassRussia:s,blockAds:i,blockPorn:l,blockUDP443:c}=e;return"localhost"!==n&&t.push(`AND,((IP-CIDR,${n}/32),(DST-PORT,53)),DIRECT`),r&&t.push("GEOSITE,private,DIRECT"),o&&t.push("GEOSITE,category-ir,DIRECT"),a&&t.push("GEOSITE,cn,DIRECT"),s&&t.push("GEOSITE,category-ru,DIRECT"),r&&t.push("GEOIP,private,DIRECT,no-resolve"),o&&t.push("GEOIP,ir,DIRECT,no-resolve"),a&&t.push("GEOIP,cn,DIRECT,no-resolve"),s&&t.push("GEOIP,ru,DIRECT,no-resolve"),c&&t.push("AND,((NETWORK,udp),(DST-PORT,443)),REJECT"),i&&t.push("GEOSITE,category-ads-all,REJECT","GEOSITE,category-ads-ir,REJECT"),l&&t.push("GEOSITE,category-porn,REJECT"),t.push("MATCH, Selector"),t}function buildClashVLESSOutbound(e,t,n,r,o,a,s){const i=!!defaultHttpsPorts.includes(n);let l={name:e,type:"vless",server:isIPv6(t)?t.replace(/\[|\]/g,""):t,port:+n,uuid:userID,tls:i,network:"ws",udp:!1,"ws-opts":{path:a,headers:{host:r},"max-early-data":2560,"early-data-header-name":"Sec-WebSocket-Protocol"}};return i&&Object.assign(l,{servername:o,alpn:["h2","http/1.1"],"client-fingerprint":"random","skip-cert-verify":s}),l}function buildClashTrojanOutbound(e,t,n,r,o,a,s){return{name:e,type:"trojan",server:isIPv6(t)?t.replace(/\[|\]/g,""):t,port:+n,password:trojanPassword,network:"ws",udp:!1,"ws-opts":{path:a,headers:{host:r},"max-early-data":2560,"early-data-header-name":"Sec-WebSocket-Protocol"},sni:o,alpn:["h2","http/1.1"],"client-fingerprint":"random","skip-cert-verify":s}}function buildClashWarpOutbound(e,t,n,r){const o=n.includes("[")?n.match(/\[(.*?)\]/)[1]:n.split(":")[0],a=n.includes("[")?+n.match(/[^:]*$/)[0]:+n.split(":")[1],{warpIPv6:s,reserved:i,publicKey:l,privateKey:c}=extractWireguardParams(e,r);return{name:t,type:"wireguard",ip:"172.16.0.2/32",ipv6:s,"private-key":c,server:o,port:a,"public-key":l,"allowed-ips":["0.0.0.0/0","::/0"],reserved:i,udp:!0,mtu:1280,"dialer-proxy":r,"remote-dns-resolve":!0,dns:["1.1.1.1","1.0.0.1"]}}function buildClashChainOutbound(e){if(["socks","http"].includes(e.protocol)){const{protocol:t,host:n,port:r,user:o,pass:a}=e;return{name:"",type:"socks"===t?"socks5":t,server:n,port:+r,"dialer-proxy":"",username:o,password:a}}const{hostName:t,port:n,uuid:r,flow:o,security:a,type:s,sni:i,fp:l,alpn:c,pbk:d,sid:u,headerType:p,host:h,path:f,serviceName:y}=e;let m={name:" Chain Best Ping ",type:"vless",server:t,port:+n,udp:!0,uuid:r,flow:o,network:s,"dialer-proxy":" Best Ping "};if("tls"===a){const e=c?c?.split(","):[];Object.assign(m,{tls:!0,servername:i,alpn:e,"client-fingerprint":l})}if("reality"===a&&Object.assign(m,{tls:!0,servername:i,"client-fingerprint":l,"reality-opts":{"public-key":d,"short-id":u}}),"http"===p){const e=f?.split(",");m["http-opts"]={method:"GET",path:e,headers:{Connection:["keep-alive"],"Content-Type":["application/octet-stream"]}}}if("ws"===s){const e=f?.split("?ed=")[0],t=+f?.split("?ed=")[1];m["ws-opts"]={path:e,headers:{Host:h},"max-early-data":t,"early-data-header-name":"Sec-WebSocket-Protocol"}}return"grpc"===s&&(m["grpc-opts"]={"grpc-service-name":y}),m}async function getClashWarpConfig(e,t){const{warpEndpoints:n}=e;let r=structuredClone(clashConfigTemp);r.dns=await buildClashDNS(e,!0),r.rules=buildClashRoutingRules(e);const o=r["proxy-groups"][0],a=r["proxy-groups"][1];o.proxies=[" Warp - Best Ping "," WoW - Best Ping "],a.name=" Warp - Best Ping ",a.interval=+e.bestWarpInterval,r["proxy-groups"].push(structuredClone(a));const s=r["proxy-groups"][2];s.name=" WoW - Best Ping ";let i=[],l=[];return n.split(",").forEach(((e,n)=>{const o=` ${n+1} - Warp `,c=` ${n+1} - WoW `,d=buildClashWarpOutbound(t,o,e,""),u=buildClashWarpOutbound(t,c,e,o);r.proxies.push(u,d),i.push(o),l.push(c),a.proxies.push(o),s.proxies.push(c)})),o.proxies.push(...i,...l),r}async function getClashNormalConfig(e,t,n){let r;const{cleanIPs:o,proxyIP:a,ports:s,vlessConfigs:i,trojanConfigs:l,outProxy:c,outProxyParams:d,customCdnAddrs:u,customCdnHost:p,customCdnSni:h,bestVLESSTrojanInterval:f,enableIPv6:y}=t;if(c){const n=JSON.parse(d);try{r=buildClashChainOutbound(n)}catch(n){console.log("An error occured while parsing chain proxy: ",n),r=void 0,await e.bpb.put("proxySettings",JSON.stringify({...t,outProxy:"",outProxyParams:""}))}}let m=structuredClone(clashConfigTemp);m.dns=await buildClashDNS(t,!1),m.rules=buildClashRoutingRules(t);const b=m["proxy-groups"][0],g=m["proxy-groups"][1];b.proxies=[" Best Ping "],g.name=" Best Ping ",g.interval=+f;const v=await getConfigAddresses(n,o,y),w=u?u.split(","):[],S=[...v,...w];let x,k=1;return[...i?["VLESS"]:[],...l?["Trojan"]:[]].forEach((e=>{let t=1;s.forEach((s=>{S.forEach((i=>{let l,c;const d=w.includes(i),u=d?"C":"",f=d?h:randomUpperCase(n),y=d?p:n,v=generateRemark(t,s,i,o,e,u).replace(" : "," - ");if("VLESS"===e&&(x=`/${getRandomPath(16)}${a?`/${btoa(a)}`:""}`,l=buildClashVLESSOutbound(r?`proxy-${k}`:v,i,s,y,f,x,d),m.proxies.push(l),b.proxies.push(v),g.proxies.push(v)),"Trojan"===e&&defaultHttpsPorts.includes(s)&&(x=`/tr${getRandomPath(16)}${a?`/${btoa(a)}`:""}`,c=buildClashTrojanOutbound(r?`proxy-${k}`:v,i,s,y,f,x,d),m.proxies.push(c),b.proxies.push(v),g.proxies.push(v)),r){let e=structuredClone(r);e.name=v,e["dialer-proxy"]=`proxy-${k}`,m.proxies.push(e)}k++,t++}))}))})),m}function buildSingBoxDNS(e,t,n){const{remoteDNS:r,localDNS:o,vlessTrojanFakeDNS:a,warpFakeDNS:s,bypassIran:i,bypassChina:l,bypassRussia:c,blockAds:d,blockPorn:u}=e;let p;const h=a&&!n||s&&n,f=[{address:n?"1.1.1.1":r,address_resolver:"dns-direct",strategy:"prefer_ipv4",detour:t?"proxy-1":"proxy",tag:"dns-remote"},{address:"localhost"===o?"local":o,strategy:"prefer_ipv4",detour:"direct",tag:"dns-direct"},{address:"rcode://success",tag:"dns-block"}];let y=[{outbound:"any",server:"dns-direct"}];if(i||l||c){let e={rule_set:[],server:"dns-direct"};i&&e.rule_set.push("geosite-ir"),l&&e.rule_set.push("geosite-cn"),c&&e.rule_set.push("geosite-category-ru"),y.push(e)}let m={disable_cache:!0,rule_set:["geosite-malware","geosite-phishing","geosite-cryptominers"],server:"dns-block"};return d&&m.rule_set.push("geosite-category-ads-all"),u&&m.rule_set.push("geosite-nsfw"),y.push(m),h&&(f.push({address:"fakeip",tag:"dns-fake"}),y.push({disable_cache:!0,inbound:"tun-in",query_type:["A","AAAA"],server:"dns-fake"}),p={enabled:!0,inet4_range:"198.18.0.0/15",inet6_range:"fc00::/18"}),{servers:f,rules:y,fakeip:p}}function buildSingBoxRoutingRules(e){const{bypassLAN:t,bypassIran:n,bypassChina:r,bypassRussia:o,blockAds:a,blockPorn:s,blockUDP443:i}=e;let l=[{inbound:"dns-in",outbound:"dns-out"},{network:"udp",port:53,outbound:"dns-out"}],c=[{type:"remote",tag:"geosite-malware",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-malware.srs",download_detour:"direct"},{type:"remote",tag:"geosite-phishing",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-phishing.srs",download_detour:"direct"},{type:"remote",tag:"geosite-cryptominers",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-cryptominers.srs",download_detour:"direct"},{type:"remote",tag:"geoip-malware",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geoip-malware.srs",download_detour:"direct"},{type:"remote",tag:"geoip-phishing",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geoip-phishing.srs",download_detour:"direct"}];n&&(l.push({rule_set:["geosite-ir","geoip-ir"],outbound:"direct"}),c.push({type:"remote",tag:"geosite-ir",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-ir.srs",download_detour:"direct"},{type:"remote",tag:"geoip-ir",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geoip-ir.srs",download_detour:"direct"})),r&&(l.push({rule_set:["geosite-cn","geoip-cn"],outbound:"direct"}),c.push({type:"remote",tag:"geosite-cn",format:"binary",url:"https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-cn.srs",download_detour:"direct"},{type:"remote",tag:"geoip-cn",format:"binary",url:"https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-cn.srs",download_detour:"direct"})),o&&(l.push({rule_set:["geosite-category-ru","geoip-ru"],outbound:"direct"}),c.push({type:"remote",tag:"geosite-category-ru",format:"binary",url:"https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-category-ru.srs",download_detour:"direct"},{type:"remote",tag:"geoip-ru",format:"binary",url:"https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-ru.srs",download_detour:"direct"})),t&&l.push({ip_is_private:!0,outbound:"direct"}),i&&l.push({network:"udp",port:443,protocol:"quic",outbound:"block"});let d={rule_set:["geosite-malware","geosite-phishing","geosite-cryptominers","geoip-malware","geoip-phishing"],outbound:"block"};return a&&(d.rule_set.push("geosite-category-ads-all"),c.push({type:"remote",tag:"geosite-category-ads-all",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-category-ads-all.srs",download_detour:"direct"})),s&&(d.rule_set.push("geosite-nsfw"),c.push({type:"remote",tag:"geosite-nsfw",format:"binary",url:"https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-nsfw.srs",download_detour:"direct"})),l.push(d),l.push({ip_cidr:["224.0.0.0/3","ff00::/8"],source_ip_cidr:["224.0.0.0/3","ff00::/8"],outbound:"block"}),{rules:l,rule_set:c}}function buildSingBoxVLESSOutbound(e,t,n,r,o,a,s,i){const{lengthMin:l,lengthMax:c,intervalMin:d,intervalMax:u,proxyIP:p}=e,h=`/${getRandomPath(16)}${p?`/${btoa(p)}`:""}`,f=!!defaultHttpsPorts.includes(r);let y={type:"vless",server:n,server_port:+r,uuid:userID,tls:{alpn:"http/1.1",enabled:!0,insecure:s,server_name:a,utls:{enabled:!0,fingerprint:"randomized"}},transport:{early_data_header_name:"Sec-WebSocket-Protocol",max_early_data:2560,headers:{Host:o},path:h,type:"ws"},tag:t};return f||delete y.tls,i&&(y.tls_fragment={enabled:!0,size:`${l}-${c}`,sleep:`${d}-${u}`}),y}function buildSingBoxTrojanOutbound(e,t,n,r,o,a,s,i){const{lengthMin:l,lengthMax:c,intervalMin:d,intervalMax:u,proxyIP:p}=e,h=`/tr${getRandomPath(16)}${p?`/${btoa(p)}`:""}`,f=!!defaultHttpsPorts.includes(r);let y={type:"trojan",password:trojanPassword,server:n,server_port:+r,tls:{alpn:"http/1.1",enabled:!0,insecure:s,server_name:a,utls:{enabled:!0,fingerprint:"randomized"}},transport:{early_data_header_name:"Sec-WebSocket-Protocol",max_early_data:2560,headers:{Host:o},path:h,type:"ws"},tag:t};return f||delete y.tls,i&&(y.tls_fragment={enabled:!0,size:`${l}-${c}`,sleep:`${d}-${u}`}),y}function buildSingBoxWarpOutbound(e,t,n,r,o,a){const s=r.includes("[")?r.match(/\[(.*?)\]/)[1]:r.split(":")[0],i=r.includes("[")?+r.match(/[^:]*$/)[0]:+r.split(":")[1],{hiddifyNoiseMode:l,noiseCountMin:c,noiseCountMax:d,noiseSizeMin:u,noiseSizeMax:p,noiseDelayMin:h,noiseDelayMax:f}=e,{warpIPv6:y,reserved:m,publicKey:b,privateKey:g}=extractWireguardParams(t,o);let v={local_address:["172.16.0.2/32",y],mtu:1280,peer_public_key:b,private_key:g,reserved:m,server:s,server_port:i,type:"wireguard",detour:o,tag:n};return"hiddify"===a&&Object.assign(v,{fake_packets_mode:l,fake_packets:c===d?c:`${c}-${d}`,fake_packets_size:u===p?u:`${u}-${p}`,fake_packets_delay:h===f?h:`${h}-${f}`}),v}function buildSingBoxChainOutbound(e){if(["socks","http"].includes(e.protocol)){const{protocol:t,host:n,port:r,user:o,pass:a}=e;let s={type:t,tag:"",server:n,server_port:+r,username:o,password:a,detour:""};return"socks"===t&&Object.assign(s,{version:"5",network:"tcp"}),s}const{hostName:t,port:n,uuid:r,flow:o,security:a,type:s,sni:i,fp:l,alpn:c,pbk:d,sid:u,headerType:p,host:h,path:f,serviceName:y}=e;let m={type:"vless",tag:"",server:t,server_port:+n,uuid:r,flow:o,network:"tcp",detour:""};if("tls"===a||"reality"===a){const e=c?c?.split(",").filter((e=>"h2"!==e)):[];m.tls={enabled:!0,server_name:i,insecure:!1,alpn:e,utls:{enabled:!0,fingerprint:l}},"reality"===a&&(m.tls.reality={enabled:!0,public_key:d,short_id:u},delete m.tls.alpn)}if("http"===p){const e=h?.split(",");m.transport={type:"http",host:e,path:f,method:"GET",headers:{Connection:["keep-alive"],"Content-Type":["application/octet-stream"]}}}if("ws"===s){const e=f?.split("?ed=")[0],t=+f?.split("?ed=")[1]||0;m.transport={type:"ws",path:e,headers:{Host:h},max_early_data:t,early_data_header_name:"Sec-WebSocket-Protocol"}}return"grpc"===s&&(m.transport={type:"grpc",service_name:y}),m}async function getSingBoxWarpConfig(e,t,n){const{warpEndpoints:r}=e;let o=structuredClone(singboxConfigTemp);const a=buildSingBoxDNS(e,!1,!0),{rules:s,rule_set:i}=buildSingBoxRoutingRules(e);o.dns.servers=a.servers,o.dns.rules=a.rules,a.fakeip&&(o.dns.fakeip=a.fakeip),o.route.rules=s,o.route.rule_set=i;const l=o.outbounds[0],c=o.outbounds[1],d="hiddify"===n?" Pro ":" ";l.outbounds=[` Warp${d}- Best Ping `,` WoW${d}- Best Ping `],o.outbounds.splice(2,0,structuredClone(c));const u=o.outbounds[2];c.tag=` Warp${d}- Best Ping `,c.interval=`${e.bestWarpInterval}s`,u.tag=` WoW${d}- Best Ping `,u.interval=`${e.bestWarpInterval}s`;let p=[],h=[];return r.split(",").forEach(((r,a)=>{const s=` ${a+1} - Warp `,i=` ${a+1} - WoW `,l=buildSingBoxWarpOutbound(e,t,s,r,"",n),d=buildSingBoxWarpOutbound(e,t,i,r,s,n);o.outbounds.push(d,l),p.push(s),h.push(i),c.outbounds.push(s),u.outbounds.push(i)})),l.outbounds.push(...p,...h),o}async function getSingBoxCustomConfig(e,t,n,r,o){let a;const{cleanIPs:s,ports:i,vlessConfigs:l,trojanConfigs:c,outProxy:d,outProxyParams:u,customCdnAddrs:p,customCdnHost:h,customCdnSni:f,bestVLESSTrojanInterval:y,enableIPv6:m}=t;if(d){const n=JSON.parse(u);try{a=buildSingBoxChainOutbound(n)}catch(n){throw console.log("An error occured while parsing chain proxy: ",n),a=void 0,await e.bpb.put("proxySettings",JSON.stringify({...t,outProxy:"",outProxyParams:""})),new Error(n)}}let b=structuredClone(singboxConfigTemp);const g=buildSingBoxDNS(t,a,!1),{rules:v,rule_set:w}=buildSingBoxRoutingRules(t);b.dns.servers=g.servers,b.dns.rules=g.rules,g.fakeip&&(b.dns.fakeip=g.fakeip),b.route.rules=v,b.route.rule_set=w;const S=b.outbounds[0],x=b.outbounds[1];S.outbounds=[" Best Ping "],x.interval=`${y}s`,x.tag=" Best Ping ";const k=await getConfigAddresses(n,s,m),_=p?p.split(","):[],C=[...k,..._],P=i.filter((e=>!o||defaultHttpsPorts.includes(e)));let E=1;return[...l?["VLESS"]:[],...c?["Trojan"]:[]].forEach((e=>{let r=1;P.forEach((i=>{C.forEach((l=>{let c,d;const u=_.includes(l),p=u?"C":o?"F":"",y=u?f:randomUpperCase(n),m=u?h:n,g=generateRemark(r,i,l,s,e,p);if("VLESS"===e&&(c=buildSingBoxVLESSOutbound(t,a?`proxy-${E}`:g,l,i,m,y,u,o),b.outbounds.push(c)),"Trojan"===e&&(d=buildSingBoxTrojanOutbound(t,a?`proxy-${E}`:g,l,i,m,y,u,o),b.outbounds.push(d)),a){let e=structuredClone(a);e.tag=g,e.detour=`proxy-${E}`,b.outbounds.push(e)}S.outbounds.push(g),x.outbounds.push(g),E++,r++}))}))})),b}async function getNormalConfigs(e,t,n){const{cleanIPs:r,proxyIP:o,ports:a,vlessConfigs:s,trojanConfigs:i,outProxy:l,customCdnAddrs:c,customCdnHost:d,customCdnSni:u,enableIPv6:p}=e;let h="",f="",y="",m=1;const b=await getConfigAddresses(t,r,p),g=c?c.split(","):[],v=[...b,...g],w="singbox"===n?"http/1.1":"h2,http/1.1",S=encodeURIComponent(trojanPassword),x="singbox"===n?"&eh=Sec-WebSocket-Protocol&ed=2560":encodeURIComponent("?ed=2560");if(a.forEach((e=>{v.forEach(((n,a)=>{const l=a>b.length-1,c=l?"C":"",p=l?u:randomUpperCase(t),y=l?d:t,g=`${getRandomPath(16)}${o?`/${encodeURIComponent(btoa(o))}`:""}${x}`,v=encodeURIComponent(generateRemark(m,e,n,r,"VLESS",c)),k=encodeURIComponent(generateRemark(m,e,n,r,"Trojan",c)),_=defaultHttpsPorts.includes(e)?`&security=tls&sni=${p}&fp=randomized&alpn=${w}`:"&security=none";s&&(h+=`${atob("dmxlc3M")}://${userID}@${n}:${e}?path=/${g}&encryption=none&host=${y}&type=ws${_}#${v}\n`),i&&(f+=`${atob("dHJvamFu")}://${S}@${n}:${e}?path=/tr${g}&host=${y}&type=ws${_}#${k}\n`),m++}))})),l){let e=`#${encodeURIComponent(" Chain proxy ")}`;if(l.startsWith("socks")||l.startsWith("http")){const t=/^(?:socks|http):\/\/([^@]+)@/,n=l.match(t),r=!!n&&n[1];y=r?l.replace(r,btoa(r))+e:l+e}else y=l.split("#")[0]+e}return btoa(h+f+y)}var xrayConfigTemp={remarks:"",log:{loglevel:"warning"},dns:{},fakedns:[{ipPool:"198.18.0.0/15",poolSize:32768},{ipPool:"fc00::/18",poolSize:32768}],inbounds:[{port:10808,protocol:"socks",settings:{auth:"noauth",udp:!0,userLevel:8},sniffing:{destOverride:["http","tls"],enabled:!0,routeOnly:!0},tag:"socks-in"},{port:10809,protocol:"http",settings:{auth:"noauth",udp:!0,userLevel:8},sniffing:{destOverride:["http","tls"],enabled:!0,routeOnly:!0},tag:"http-in"},{listen:"127.0.0.1",port:10853,protocol:"dokodemo-door",settings:{address:"1.1.1.1",network:"tcp,udp",port:53},tag:"dns-in"}],outbounds:[{tag:"fragment",protocol:"freedom",settings:{fragment:{packets:"tlshello",length:"",interval:""},domainStrategy:"UseIP"},streamSettings:{sockopt:{tcpKeepAliveIdle:100,tcpNoDelay:!0}}},{protocol:"dns",tag:"dns-out"},{protocol:"freedom",settings:{},tag:"direct"},{protocol:"blackhole",settings:{response:{type:"http"}},tag:"block"}],policy:{levels:{8:{connIdle:300,downlinkOnly:1,handshake:4,uplinkOnly:1}},system:{statsOutboundUplink:!0,statsOutboundDownlink:!0}},routing:{domainStrategy:"IPIfNonMatch",rules:[],balancers:[{tag:"all",selector:["prox"],strategy:{type:"leastPing"}}]},observatory:{probeInterval:"30s",probeURL:"https://www.gstatic.com/generate_204",subjectSelector:["prox"],EnableConcurrency:!0},stats:{}},singboxConfigTemp={log:{level:"warn",timestamp:!0},dns:{servers:[],rules:[],independent_cache:!0},inbounds:[{type:"direct",tag:"dns-in",listen:"0.0.0.0",listen_port:6450,override_address:"8.8.8.8",override_port:53},{type:"tun",tag:"tun-in",inet4_address:"172.19.0.1/28",inet6_address:"fdfe:dcba:9876::1/126",mtu:9e3,auto_route:!0,strict_route:!0,stack:"mixed",sniff:!0,sniff_override_destination:!0},{type:"mixed",tag:"mixed-in",listen:"0.0.0.0",listen_port:2080,sniff:!0,sniff_override_destination:!1}],outbounds:[{type:"selector",tag:"proxy",outbounds:[]},{type:"urltest",tag:"",outbounds:[],url:"https://www.gstatic.com/generate_204",interval:""},{type:"direct",tag:"direct"},{type:"block",tag:"block"},{type:"dns",tag:"dns-out"}],route:{rules:[],rule_set:[],auto_detect_interface:!0,override_android_vpn:!0,final:"proxy"},ntp:{enabled:!0,server:"time.apple.com",server_port:123,detour:"direct",interval:"30m"},experimental:{cache_file:{enabled:!0,store_fakeip:!0},clash_api:{external_controller:"0.0.0.0:9090",external_ui:"yacd",external_ui_download_url:"https://github.com/MetaCubeX/Yacd-meta/archive/gh-pages.zip",external_ui_download_detour:"direct",default_mode:"rule"}}},clashConfigTemp={"mixed-port":7890,ipv6:!0,"allow-lan":!0,mode:"rule","log-level":"info","keep-alive-interval":30,"unified-delay":!1,dns:{},tun:{enable:!0,stack:"system","auto-route":!0,"auto-redirect":!0,"auto-detect-interface":!0,"dns-hijack":["any:53","198.18.0.2:53"],device:"utun0",mtu:9e3,"strict-route":!0},sniffer:{enable:!0,"force-dns-mapping":!0,"parse-pure-ip":!0,sniff:{HTTP:{ports:[80,8080,8880,2052,2082,2086,2095],"override-destination":!1},TLS:{ports:[443,8443,2053,2083,2087,2096],"override-destination":!1}}},proxies:[],"proxy-groups":[{name:" Selector",type:"select",proxies:[]},{name:"",type:"url-test",url:"https://www.gstatic.com/generate_204",interval:30,tolerance:50,proxies:[]}],rules:[],ntp:{enable:!0,server:"time.apple.com",port:123,interval:30}};export{worker_default as default};
/*! Bundled license information:

js-sha256/src/sha256.js:
  (**
   * [js-sha256]{@link https://github.com/emn178/js-sha256}
   *
   * @version 0.11.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2024
   * @license MIT
   *)
*/
